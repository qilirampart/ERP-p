# å¤šè¡¨æ•°æ®åŒæ­¥å®žçŽ°æ–¹æ¡ˆè¯¦è§£

## ä¸šåŠ¡åœºæ™¯åˆ†æž

åœ¨æˆ‘ä»¬çš„ERPç³»ç»Ÿä¸­ï¼Œå­˜åœ¨å…¸åž‹çš„"ä¸€å¯¹å¤š"å…³ç³»ï¼š

```
è®¢å•è¡¨ (Order)                     ç”Ÿäº§å·¥å•è¡¨ (ProductionOrder)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ id: 1           â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ id: 1                â”‚
â”‚ order_no: SO001 â”‚           â”‚   â”‚ order_id: 1          â”‚
â”‚ status: ?       â”‚â—„â”€â”€â”€â”€â”€â”€â”   â””â”€â”€â”€â”‚ status: COMPLETED    â”‚
â”‚ ...             â”‚       â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚       â”‚ id: 2                â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”‚ order_id: 1          â”‚
                                  â”‚ status: COMPLETED    â”‚
                                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

é—®é¢˜ï¼šå½“æ‰€æœ‰ç”Ÿäº§å·¥å•éƒ½å®Œæˆæ—¶ï¼Œè®¢å•çŠ¶æ€åº”è¯¥è‡ªåŠ¨å˜ä¸º"å·²å®Œæˆ"
```

---

## æ–¹æ¡ˆä¸€ï¼šåº”ç”¨å±‚é€»è¾‘åŒæ­¥ â­ (æœ¬é¡¹ç›®é‡‡ç”¨)

### 1.1 å®žçŽ°åŽŸç†

**åœ¨åº”ç”¨ä»£ç ä¸­ç¼–å†™ä¸šåŠ¡é€»è¾‘ï¼Œä¸»åŠ¨æ£€æŸ¥å¹¶æ›´æ–°å…³è”è¡¨**

```python
async def update_production_order(db, production_id, data):
    """æ›´æ–°ç”Ÿäº§å·¥å• - åº”ç”¨å±‚åŒæ­¥"""

    # ç¬¬1æ­¥ï¼šåŠ è½½ç”Ÿäº§å·¥å•å’Œå…³è”çš„è®¢å•
    stmt = (
        select(ProductionOrder)
        .where(ProductionOrder.id == production_id)
        .options(selectinload(ProductionOrder.order))  # ðŸ”‘ é¢„åŠ è½½å…³è”è®¢å•
    )
    production_order = await db.execute(stmt).scalar_one()

    # ç¬¬2æ­¥ï¼šè®°å½•åŽŸå§‹çŠ¶æ€
    old_status = production_order.status

    # ç¬¬3æ­¥ï¼šæ›´æ–°ç”Ÿäº§å·¥å•
    for key, value in data.items():
        setattr(production_order, key, value)

    await db.flush()  # ðŸ”‘ åˆ·æ–°åˆ°æ•°æ®åº“ä½†ä¸æäº¤

    # ç¬¬4æ­¥ï¼šæ£€æµ‹çŠ¶æ€å˜æ›´ â†’ è§¦å‘åŒæ­¥é€»è¾‘
    if old_status != "COMPLETED" and production_order.status == "COMPLETED":

        # ç¬¬5æ­¥ï¼šæŸ¥è¯¢è¯¥è®¢å•çš„å…¶ä»–å·¥å•çŠ¶æ€
        stmt = select(ProductionOrder).where(
            and_(
                ProductionOrder.order_id == production_order.order_id,
                ProductionOrder.status != "COMPLETED"
            )
        )
        unfinished = await db.execute(stmt).scalars().all()

        # ç¬¬6æ­¥ï¼šå¦‚æžœæ‰€æœ‰å·¥å•éƒ½å®Œæˆäº†ï¼ŒåŒæ­¥æ›´æ–°è®¢å•çŠ¶æ€
        if not unfinished:  # ðŸ”‘ ä¸šåŠ¡é€»è¾‘åˆ¤æ–­
            production_order.order.status = "COMPLETED"  # ðŸ“ æ›´æ–°å…³è”è¡¨
            production_order.order.updated_at = datetime.now()

    # ç¬¬7æ­¥ï¼šä¸€æ¬¡æ€§æäº¤æ‰€æœ‰å˜æ›´
    await db.commit()  # ðŸ”‘ äº‹åŠ¡ä¿è¯åŽŸå­æ€§

    return production_order
```

### 1.2 å…³é”®æŠ€æœ¯ç‚¹

#### æŠ€æœ¯ç‚¹1: ORMå…³ç³»åŠ è½½
```python
# SQLAlchemy é¢„åŠ è½½å…³è”å¯¹è±¡
.options(selectinload(ProductionOrder.order))

# æ•ˆæžœï¼šproduction_order.order å¯ä»¥ç›´æŽ¥è®¿é—®è®¢å•å¯¹è±¡
# é¿å…äº† N+1 æŸ¥è¯¢é—®é¢˜
```

#### æŠ€æœ¯ç‚¹2: æ•°æ®åº“äº‹åŠ¡
```python
async with db.begin():  # å¼€å¯äº‹åŠ¡
    # æ“ä½œ1ï¼šæ›´æ–°ç”Ÿäº§å·¥å•
    production_order.status = "COMPLETED"

    # æ“ä½œ2ï¼šæ›´æ–°è®¢å•
    order.status = "COMPLETED"

    # ä¸€èµ·æäº¤æˆ–ä¸€èµ·å›žæ»š
    await db.commit()
```

#### æŠ€æœ¯ç‚¹3: flush vs commit
```python
await db.flush()   # å‘é€SQLåˆ°æ•°æ®åº“ï¼Œä½†ä¸æäº¤äº‹åŠ¡
                   # å…¶ä»–æŸ¥è¯¢å¯ä»¥çœ‹åˆ°å˜æ›´
                   # ä½†äº‹åŠ¡æœªç»“æŸï¼Œå¯ä»¥å›žæ»š

await db.commit()  # æäº¤äº‹åŠ¡ï¼Œå˜æ›´æ°¸ä¹…ç”Ÿæ•ˆ
                   # äº‹åŠ¡ç»“æŸ
```

### 1.3 å®Œæ•´æ‰§è¡Œæµç¨‹

```
ç”¨æˆ·æ“ä½œï¼šæ›´æ–°å·¥å•çŠ¶æ€ä¸º"å·²å®Œæˆ"
    â†“
åº”ç”¨å±‚æŽ¥æ”¶è¯·æ±‚
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ äº‹åŠ¡å¼€å§‹ (BEGIN)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. SELECT ç”Ÿäº§å·¥å• + è®¢å• (åŠ é”)         â”‚
â”‚ 2. UPDATE ç”Ÿäº§å·¥å• status='COMPLETED'    â”‚
â”‚ 3. FLUSH (ç”ŸæˆSQLä½†ä¸æäº¤)               â”‚
â”‚ 4. SELECT æŸ¥è¯¢è¯¥è®¢å•çš„å…¶ä»–å·¥å•            â”‚
â”‚ 5. IF æ‰€æœ‰å·¥å•éƒ½å®Œæˆ:                    â”‚
â”‚      UPDATE è®¢å• status='COMPLETED'       â”‚
â”‚ 6. COMMIT (æäº¤æ‰€æœ‰å˜æ›´)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
æ•°æ®åº“çŠ¶æ€ä¸€è‡´ï¼šå·¥å•âœ…å®Œæˆï¼Œè®¢å•âœ…å®Œæˆ
```

### 1.4 ä¼˜ç‚¹ âœ…
- âœ… **ä¸šåŠ¡é€»è¾‘æ¸…æ™°**: ä»£ç ç›´è§‚ï¼Œæ˜“äºŽç†è§£å’Œç»´æŠ¤
- âœ… **çµæ´»æ€§é«˜**: å¯ä»¥æ·»åŠ å¤æ‚çš„ä¸šåŠ¡è§„åˆ™ï¼ˆå¦‚é€šçŸ¥ã€æ—¥å¿—ï¼‰
- âœ… **è·¨æ•°æ®åº“å…¼å®¹**: ä¸ä¾èµ–ç‰¹å®šæ•°æ®åº“ç‰¹æ€§
- âœ… **ä¾¿äºŽè°ƒè¯•**: å¯ä»¥æ–­ç‚¹è°ƒè¯•ï¼ŒæŸ¥çœ‹ä¸­é—´çŠ¶æ€
- âœ… **å•å…ƒæµ‹è¯•å‹å¥½**: æ˜“äºŽç¼–å†™æµ‹è¯•ç”¨ä¾‹

### 1.5 ç¼ºç‚¹ âŒ
- âŒ **éœ€è¦æ˜¾å¼ç¼–ç **: æ¯ä¸ªéœ€è¦åŒæ­¥çš„åœ°æ–¹éƒ½è¦å†™ä»£ç 
- âŒ **å¯èƒ½é—æ¼**: å¦‚æžœæœ‰å¤šä¸ªå…¥å£ï¼Œå®¹æ˜“å¿˜è®°åŒæ­¥é€»è¾‘
- âŒ **æ€§èƒ½ç¨å·®**: éœ€è¦é¢å¤–çš„æŸ¥è¯¢æ¥æ£€æŸ¥çŠ¶æ€

---

## æ–¹æ¡ˆäºŒï¼šæ•°æ®åº“è§¦å‘å™¨ (Trigger)

### 2.1 å®žçŽ°åŽŸç†

**åœ¨æ•°æ®åº“å±‚é¢å®šä¹‰è§¦å‘å™¨ï¼Œè‡ªåŠ¨å“åº”æ•°æ®å˜æ›´**

```sql
-- åˆ›å»ºè§¦å‘å™¨
DELIMITER $$

CREATE TRIGGER sync_order_status_on_production_update
AFTER UPDATE ON erp_production_orders
FOR EACH ROW
BEGIN
    -- å£°æ˜Žå˜é‡
    DECLARE unfinished_count INT;

    -- ä»…å½“å·¥å•çŠ¶æ€å˜ä¸ºCOMPLETEDæ—¶æ‰§è¡Œ
    IF NEW.status = 'COMPLETED' AND OLD.status != 'COMPLETED' THEN

        -- æ£€æŸ¥è¯¥è®¢å•çš„æœªå®Œæˆå·¥å•æ•°é‡
        SELECT COUNT(*) INTO unfinished_count
        FROM erp_production_orders
        WHERE order_id = NEW.order_id
          AND status != 'COMPLETED'
          AND id != NEW.id;

        -- å¦‚æžœæ²¡æœ‰æœªå®Œæˆçš„å·¥å•ï¼Œæ›´æ–°è®¢å•çŠ¶æ€
        IF unfinished_count = 0 THEN
            UPDATE erp_orders
            SET status = 'COMPLETED',
                updated_at = NOW()
            WHERE id = NEW.order_id;
        END IF;

    END IF;
END$$

DELIMITER ;
```

### 2.2 æ‰§è¡Œæµç¨‹

```
åº”ç”¨å±‚æ‰§è¡Œï¼š
UPDATE erp_production_orders
SET status='COMPLETED'
WHERE id=1;
    â†“
æ•°æ®åº“è‡ªåŠ¨è§¦å‘ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è§¦å‘å™¨æ‰§è¡Œ                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. OLD.status = 'IN_PROGRESS'   â”‚
â”‚ 2. NEW.status = 'COMPLETED'     â”‚
â”‚ 3. æ¡ä»¶æ»¡è¶³ï¼Œæ‰§è¡Œè§¦å‘å™¨é€»è¾‘      â”‚
â”‚ 4. SELECT COUNT(*) æŸ¥è¯¢æœªå®Œæˆ   â”‚
â”‚ 5. IF æœªå®Œæˆ=0:                 â”‚
â”‚      UPDATE erp_orders          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
ä¸€æ¡UPDATEè¯­å¥ï¼Œä¸¤å¼ è¡¨éƒ½æ›´æ–°äº†ï¼
```

### 2.3 ä¼˜ç‚¹ âœ…
- âœ… **è‡ªåŠ¨æ‰§è¡Œ**: åº”ç”¨å±‚æ— éœ€å…³å¿ƒåŒæ­¥é€»è¾‘
- âœ… **æ•°æ®ä¸€è‡´æ€§å¼º**: æ•°æ®åº“å±‚é¢ä¿è¯
- âœ… **æ€§èƒ½å¥½**: å‡å°‘åº”ç”¨å±‚å¾€è¿”æ¬¡æ•°

### 2.4 ç¼ºç‚¹ âŒ
- âŒ **è°ƒè¯•å›°éš¾**: è§¦å‘å™¨é€»è¾‘ä¸å¯è§ï¼Œéš¾ä»¥è¿½è¸ª
- âŒ **ç§»æ¤æ€§å·®**: ä¸åŒæ•°æ®åº“è¯­æ³•ä¸åŒ
- âŒ **ç»´æŠ¤å›°éš¾**: è§¦å‘å™¨é€»è¾‘åˆ†æ•£åœ¨æ•°æ®åº“ä¸­
- âŒ **æµ‹è¯•å›°éš¾**: éš¾ä»¥æ¨¡æ‹Ÿè§¦å‘å™¨è¡Œä¸º
- âŒ **å¯èƒ½é€’å½’**: è§¦å‘å™¨è°ƒç”¨è§¦å‘å™¨ï¼Œå¯¼è‡´æ­»å¾ªçŽ¯

---

## æ–¹æ¡ˆä¸‰ï¼šæ•°æ®åº“çº§è”æ“ä½œ (CASCADE)

### 3.1 å®žçŽ°åŽŸç†

**åˆ©ç”¨å¤–é”®çº¦æŸçš„çº§è”ç‰¹æ€§**

```sql
-- åˆ›å»ºè¡¨æ—¶å®šä¹‰çº§è”è§„åˆ™
CREATE TABLE erp_production_orders (
    id INT PRIMARY KEY,
    order_id INT,
    status VARCHAR(20),

    -- å¤–é”®çº§è”
    FOREIGN KEY (order_id)
    REFERENCES erp_orders(id)
    ON UPDATE CASCADE   -- ä¸»è¡¨æ›´æ–°æ—¶çº§è”æ›´æ–°
    ON DELETE CASCADE   -- ä¸»è¡¨åˆ é™¤æ—¶çº§è”åˆ é™¤
);
```

### 3.2 é€‚ç”¨åœºæ™¯

**CASCADEä¸»è¦ç”¨äºŽåˆ é™¤/æ›´æ–°å¤–é”®å€¼ï¼Œä¸é€‚åˆæˆ‘ä»¬çš„çŠ¶æ€åŒæ­¥åœºæ™¯**

```sql
-- âœ… é€‚ç”¨ï¼šåˆ é™¤è®¢å•æ—¶è‡ªåŠ¨åˆ é™¤æ‰€æœ‰å·¥å•
DELETE FROM erp_orders WHERE id = 1;
-- è‡ªåŠ¨æ‰§è¡Œï¼šDELETE FROM erp_production_orders WHERE order_id = 1;

-- âŒ ä¸é€‚ç”¨ï¼šå·¥å•å®Œæˆæ—¶æ›´æ–°è®¢å•çŠ¶æ€
-- CASCADE æ— æ³•å®žçŽ°è¿™ç§åå‘åŒæ­¥
```

### 3.3 ä¼˜ç‚¹ âœ…
- âœ… åˆ é™¤/æ›´æ–°å¤–é”®æ—¶éžå¸¸æ–¹ä¾¿

### 3.4 ç¼ºç‚¹ âŒ
- âŒ åªèƒ½åŒæ­¥å¤–é”®åˆ—ï¼Œä¸èƒ½åŒæ­¥å…¶ä»–å­—æ®µ
- âŒ æ— æ³•å®žçŽ°å¤æ‚ä¸šåŠ¡é€»è¾‘ï¼ˆå¦‚"å…¨éƒ¨å®Œæˆ"åˆ¤æ–­ï¼‰

---

## æ–¹æ¡ˆå››ï¼šäº‹ä»¶ç›‘å¬æœºåˆ¶ (SQLAlchemy Events)

### 4.1 å®žçŽ°åŽŸç†

**åœ¨ORMå±‚é¢ç›‘å¬æ¨¡åž‹å˜æ›´äº‹ä»¶**

```python
from sqlalchemy import event
from sqlalchemy.orm import Session

@event.listens_for(ProductionOrder, 'after_update')
def sync_order_status(mapper, connection, target):
    """ç”Ÿäº§å·¥å•æ›´æ–°åŽè§¦å‘"""

    # target æ˜¯è¢«æ›´æ–°çš„ ProductionOrder å¯¹è±¡

    # æ£€æŸ¥çŠ¶æ€æ˜¯å¦å˜ä¸ºCOMPLETED
    session = Session.object_session(target)
    history = session.query(ProductionOrder).get(target.id)

    if target.status == ProductionStatus.COMPLETED:
        # æŸ¥è¯¢è¯¥è®¢å•çš„å…¶ä»–å·¥å•
        unfinished = session.query(ProductionOrder).filter(
            ProductionOrder.order_id == target.order_id,
            ProductionOrder.status != ProductionStatus.COMPLETED
        ).count()

        # å¦‚æžœå…¨éƒ¨å®Œæˆï¼Œæ›´æ–°è®¢å•
        if unfinished == 0:
            order = session.query(Order).get(target.order_id)
            order.status = OrderStatus.COMPLETED
            order.updated_at = datetime.now()
```

### 4.2 ä¼˜ç‚¹ âœ…
- âœ… äº‹ä»¶é©±åŠ¨ï¼Œè‡ªåŠ¨è§¦å‘
- âœ… ORMå±‚é¢ï¼Œä¾¿äºŽè°ƒè¯•
- âœ… ä¸Žåº”ç”¨ä»£ç åˆ†ç¦»

### 4.3 ç¼ºç‚¹ âŒ
- âŒ ç»‘å®šåˆ°ORMæ¡†æž¶ï¼ˆSQLAlchemyï¼‰
- âŒ äº‹ä»¶å¤„ç†å™¨ä¸­çš„é€»è¾‘éš¾ä»¥å•å…ƒæµ‹è¯•
- âŒ å¯èƒ½å½±å“æ€§èƒ½ï¼ˆæ¯æ¬¡æ›´æ–°éƒ½è§¦å‘ï¼‰

---

## æ–¹æ¡ˆäº”ï¼šæ¶ˆæ¯é˜Ÿåˆ—å¼‚æ­¥åŒæ­¥

### 5.1 å®žçŽ°åŽŸç†

**é€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—è§£è€¦æ›´æ–°å’ŒåŒæ­¥**

```python
from celery import Celery

# 1. æ›´æ–°å·¥å•æ—¶å‘é€æ¶ˆæ¯
async def update_production_order(db, production_id, data):
    production_order.status = "COMPLETED"
    await db.commit()

    # å‘é€å¼‚æ­¥æ¶ˆæ¯
    sync_order_status_task.delay(production_order.order_id)

# 2. å¼‚æ­¥ä»»åŠ¡å¤„ç†åŒæ­¥
@celery.task
def sync_order_status_task(order_id):
    with db.session() as session:
        # æ£€æŸ¥è®¢å•çš„æ‰€æœ‰å·¥å•
        unfinished = session.query(ProductionOrder).filter(
            ProductionOrder.order_id == order_id,
            ProductionOrder.status != "COMPLETED"
        ).count()

        # æ›´æ–°è®¢å•çŠ¶æ€
        if unfinished == 0:
            order = session.query(Order).get(order_id)
            order.status = "COMPLETED"
            session.commit()
```

### 5.2 ä¼˜ç‚¹ âœ…
- âœ… é«˜æ€§èƒ½ï¼šæ›´æ–°æ“ä½œç«‹å³è¿”å›ž
- âœ… å¯é æ€§ï¼šæ¶ˆæ¯é˜Ÿåˆ—ä¿è¯ä¸ä¸¢å¤±
- âœ… å¯æ‰©å±•ï¼šå¯ä»¥å¤„ç†å¤§é‡åŒæ­¥ä»»åŠ¡

### 5.3 ç¼ºç‚¹ âŒ
- âŒ **æœ€ç»ˆä¸€è‡´æ€§**: ä¸æ˜¯ç«‹å³åŒæ­¥
- âŒ **æž¶æž„å¤æ‚**: éœ€è¦å¼•å…¥æ¶ˆæ¯é˜Ÿåˆ—
- âŒ **è°ƒè¯•å›°éš¾**: å¼‚æ­¥æµç¨‹éš¾ä»¥è¿½è¸ª

---

## æ–¹æ¡ˆå¯¹æ¯”è¡¨

| æ–¹æ¡ˆ | å®žçŽ°å¤æ‚åº¦ | æ€§èƒ½ | ä¸€è‡´æ€§ | è°ƒè¯•éš¾åº¦ | é€‚ç”¨åœºæ™¯ |
|------|-----------|------|--------|---------|---------|
| **åº”ç”¨å±‚é€»è¾‘** | â­â­ ä¸­ç­‰ | â­â­â­ è¾ƒå¥½ | â­â­â­â­â­ å¼ºä¸€è‡´ | â­â­â­â­â­ å®¹æ˜“ | âœ… **é€šç”¨ï¼ŒæŽ¨è** |
| **æ•°æ®åº“è§¦å‘å™¨** | â­â­â­â­ å¤æ‚ | â­â­â­â­â­ æœ€å¥½ | â­â­â­â­â­ å¼ºä¸€è‡´ | â­â­ å›°éš¾ | ç®€å•åŒæ­¥é€»è¾‘ |
| **çº§è”æ“ä½œ** | â­ ç®€å• | â­â­â­â­â­ æœ€å¥½ | â­â­â­â­â­ å¼ºä¸€è‡´ | â­â­â­â­ è¾ƒæ˜“ | å¤–é”®åŒæ­¥ |
| **äº‹ä»¶ç›‘å¬** | â­â­â­ ä¸­ç­‰ | â­â­â­ è¾ƒå¥½ | â­â­â­â­â­ å¼ºä¸€è‡´ | â­â­â­ ä¸€èˆ¬ | ORMé¡¹ç›® |
| **æ¶ˆæ¯é˜Ÿåˆ—** | â­â­â­â­â­ å¾ˆå¤æ‚ | â­â­â­â­â­ æœ€å¥½ | â­â­â­ æœ€ç»ˆä¸€è‡´ | â­â­ å›°éš¾ | é«˜å¹¶å‘ç³»ç»Ÿ |

---

## æœ¬é¡¹ç›®çš„é€‰æ‹©ï¼šåº”ç”¨å±‚é€»è¾‘

### ä¸ºä»€ä¹ˆé€‰æ‹©åº”ç”¨å±‚å®žçŽ°ï¼Ÿ

1. **ä¸šåŠ¡é€»è¾‘æ¸…æ™°**
   ```python
   # ä¸€çœ¼å°±èƒ½çœ‹å‡ºåœ¨åšä»€ä¹ˆ
   if all_productions_completed:
       order.status = "COMPLETED"
   ```

2. **ä¾¿äºŽæ‰©å±•**
   ```python
   # å¯ä»¥è½»æ¾æ·»åŠ å…¶ä»–ä¸šåŠ¡é€»è¾‘
   if all_productions_completed:
       order.status = "COMPLETED"
       send_notification(order)  # å‘é€é€šçŸ¥
       log_event(order)          # è®°å½•æ—¥å¿—
       update_inventory(order)   # æ›´æ–°åº“å­˜
   ```

3. **æ˜“äºŽæµ‹è¯•**
   ```python
   async def test_sync_order_status():
       # åˆ›å»ºè®¢å•å’Œå·¥å•
       order = await create_order()
       prod1 = await create_production(order.id)

       # å®Œæˆå·¥å•
       await update_production(prod1.id, {"status": "COMPLETED"})

       # æ–­è¨€è®¢å•çŠ¶æ€å·²åŒæ­¥
       updated_order = await get_order(order.id)
       assert updated_order.status == "COMPLETED"
   ```

4. **æ¡†æž¶æ— å…³**
   - å¯ä»¥è¿ç§»åˆ°å…¶ä»–ORMï¼ˆå¦‚Django ORMã€Peeweeï¼‰
   - å¯ä»¥è¿ç§»åˆ°å…¶ä»–æ•°æ®åº“ï¼ˆPostgreSQLã€MongoDBï¼‰

---

## æœ€ä½³å®žè·µå»ºè®®

### 1. é›†ä¸­ç®¡ç†åŒæ­¥é€»è¾‘

```python
# âŒ ä¸å¥½ï¼šåˆ°å¤„å†™åŒæ­¥ä»£ç 
def update_by_api():
    production.status = "COMPLETED"
    # åŒæ­¥é€»è¾‘...

def update_by_batch():
    production.status = "COMPLETED"
    # åŒæ­¥é€»è¾‘... (é‡å¤ä»£ç )

# âœ… å¥½ï¼šç»Ÿä¸€çš„æ›´æ–°å‡½æ•°
async def update_production_status(db, production_id, new_status):
    """ç»Ÿä¸€çš„å·¥å•çŠ¶æ€æ›´æ–°å…¥å£"""
    production = await get_production(production_id)
    production.status = new_status

    # åŒæ­¥é€»è¾‘åªå†™ä¸€æ¬¡
    await sync_order_status_if_needed(db, production)

    await db.commit()
```

### 2. ä½¿ç”¨äº‹åŠ¡ä¿è¯åŽŸå­æ€§

```python
# âœ… ä½¿ç”¨äº‹åŠ¡
async with db.begin():  # å¼€å¯äº‹åŠ¡
    # å¤šä¸ªæ“ä½œåœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­
    production.status = "COMPLETED"
    order.status = "COMPLETED"
    # è¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å›žæ»š
```

### 3. æ·»åŠ å¹‚ç­‰æ€§æ£€æŸ¥

```python
def sync_order_status(order):
    # å¹‚ç­‰æ€§æ£€æŸ¥ï¼šå·²ç»æ˜¯å®ŒæˆçŠ¶æ€å°±ä¸å¤„ç†
    if order.status == "COMPLETED":
        return

    # æ£€æŸ¥æ‰€æœ‰å·¥å•
    if all_productions_completed(order):
        order.status = "COMPLETED"
```

### 4. è®°å½•æ—¥å¿—

```python
import logging

logger = logging.getLogger(__name__)

async def sync_order_status(db, production):
    unfinished = await count_unfinished(production.order_id)

    if unfinished == 0:
        logger.info(
            f"è®¢å• {production.order_id} çš„æ‰€æœ‰å·¥å•å·²å®Œæˆï¼Œ"
            f"æ›´æ–°è®¢å•çŠ¶æ€ä¸ºCOMPLETED"
        )
        order.status = "COMPLETED"
```

---

## æ€»ç»“

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å¤šè¡¨æ•°æ®åŒæ­¥çš„æœ¬è´¨                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                     â”‚
â”‚  å½“è¡¨Açš„æ•°æ®å˜åŒ–æ—¶ï¼Œè‡ªåŠ¨æ£€æŸ¥å¹¶æ›´æ–°è¡¨Bçš„æ•°æ®         â”‚
â”‚                                                     â”‚
â”‚  æ ¸å¿ƒè¦ç´ ï¼š                                         â”‚
â”‚  1. å˜æ›´æ£€æµ‹ - çŸ¥é“ä»€ä¹ˆæ—¶å€™éœ€è¦åŒæ­¥                 â”‚
â”‚  2. ä¸šåŠ¡è§„åˆ™ - çŸ¥é“æ€Žä¹ˆè®¡ç®—æ–°çš„å€¼                   â”‚
â”‚  3. æ›´æ–°æ‰§è¡Œ - çŸ¥é“å¦‚ä½•å®‰å…¨åœ°æ›´æ–°                   â”‚
â”‚  4. äº‹åŠ¡ä¿è¯ - ç¡®ä¿æ•°æ®ä¸€è‡´æ€§                       â”‚
â”‚                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æŽ¨èæ–¹æ¡ˆ**:
- ðŸ† **ä¸­å°åž‹é¡¹ç›®**: åº”ç”¨å±‚é€»è¾‘ï¼ˆç®€å•ã€å¯é ã€æ˜“ç»´æŠ¤ï¼‰
- ðŸš€ **é«˜å¹¶å‘é¡¹ç›®**: æ¶ˆæ¯é˜Ÿåˆ—å¼‚æ­¥åŒæ­¥
- ðŸ’¾ **æ•°æ®åº“å±‚é€»è¾‘ç®€å•**: è€ƒè™‘è§¦å‘å™¨

**æ ¸å¿ƒåŽŸåˆ™**: **ç®€å•ã€å¯æµ‹è¯•ã€å¯ç»´æŠ¤ > é«˜æ€§èƒ½**
