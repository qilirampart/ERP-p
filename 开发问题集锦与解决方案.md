# å°åˆ·ERPç³»ç»Ÿå¼€å‘é—®é¢˜é›†é”¦ä¸è§£å†³æ–¹æ¡ˆ

**æ–‡æ¡£ç›®çš„**: è®°å½•å¼€å‘è¿‡ç¨‹ä¸­é‡åˆ°çš„å…¸å‹é—®é¢˜ã€è§£å†³æ–¹æ¡ˆå’Œå­¦ä¹ è¦ç‚¹
**ç»´æŠ¤åŸåˆ™**: æ¯æ¬¡é‡åˆ°æœ‰ä»·å€¼çš„é—®é¢˜éƒ½åº”è¯¥æ·»åŠ åˆ°æœ¬æ–‡æ¡£
**å­¦ä¹ ä»·å€¼**: â­â­â­â­â­ é«˜ä»·å€¼é—®é¢˜ä¼˜å…ˆè®°å½•

---

## ç›®å½•

- [ä¸€ã€åç«¯å¼€å‘é—®é¢˜](#ä¸€åç«¯å¼€å‘é—®é¢˜)
  - [1.1 å¤šè¡¨æ•°æ®åŒæ­¥ä¸çŠ¶æ€ç®¡ç†](#11-å¤šè¡¨æ•°æ®åŒæ­¥ä¸çŠ¶æ€ç®¡ç†)
  - [1.2 Pydanticæ¨¡å‹å®šä¹‰é—®é¢˜](#12-pydanticæ¨¡å‹å®šä¹‰é—®é¢˜)
  - [1.3 æ¨¡å—å¯¼å…¥ä¸ä¾èµ–ç®¡ç†](#13-æ¨¡å—å¯¼å…¥ä¸ä¾èµ–ç®¡ç†)
  - [1.4 æ•°æ®åº“ä¼šè¯ä¸äº‹åŠ¡ç®¡ç†](#14-æ•°æ®åº“ä¼šè¯ä¸äº‹åŠ¡ç®¡ç†)
  - [1.5 PDFç”Ÿæˆä¸æ–‡ä»¶ä¸‹è½½é—®é¢˜](#15-pdfç”Ÿæˆä¸æ–‡ä»¶ä¸‹è½½é—®é¢˜)
- [äºŒã€å‰ç«¯å¼€å‘é—®é¢˜](#äºŒå‰ç«¯å¼€å‘é—®é¢˜)
  - [2.1 è·¯ç”±é…ç½®ä¸å¯¼èˆªé—®é¢˜](#21-è·¯ç”±é…ç½®ä¸å¯¼èˆªé—®é¢˜)
  - [2.2 çŠ¶æ€ç®¡ç†ä¸æ•°æ®æŒä¹…åŒ–](#22-çŠ¶æ€ç®¡ç†ä¸æ•°æ®æŒä¹…åŒ–)
  - [2.3 Excelæ–‡ä»¶ä¸‹è½½å“åº”æ‹¦æˆªå™¨å†²çª](#23-excelæ–‡ä»¶ä¸‹è½½å“åº”æ‹¦æˆªå™¨å†²çª)
- [ä¸‰ã€æ•°æ®åº“è®¾è®¡é—®é¢˜](#ä¸‰æ•°æ®åº“è®¾è®¡é—®é¢˜)
- [å››ã€ç³»ç»Ÿæ¶æ„é—®é¢˜](#å››ç³»ç»Ÿæ¶æ„é—®é¢˜)
- [äº”ã€æ€§èƒ½ä¼˜åŒ–é—®é¢˜](#äº”æ€§èƒ½ä¼˜åŒ–é—®é¢˜)

---

## ä¸€ã€åç«¯å¼€å‘é—®é¢˜

### 1.1 å¤šè¡¨æ•°æ®åŒæ­¥ä¸çŠ¶æ€ç®¡ç†

#### ğŸ“‹ é—®é¢˜æè¿°

**ç°è±¡**:
```
è®¢å•é¡µé¢æ˜¾ç¤º: çŠ¶æ€=ç”Ÿäº§ä¸­ âŒ
ç”Ÿäº§æ’ç¨‹é¡µé¢æ˜¾ç¤º: æ‰€æœ‰å·¥å•å·²å®Œæˆ âœ…
ä¸¤ä¸ªé¡µé¢æ•°æ®ä¸ä¸€è‡´
```

**å…·ä½“æ¡ˆä¾‹**:
- è®¢å•å·: SO20251222000705
- ç”Ÿäº§å·¥å•: 1/1 å·²å®Œæˆ
- è®¢å•çŠ¶æ€: PRODUCTION (åº”è¯¥æ˜¯ COMPLETED)

#### ğŸ” æ ¹æœ¬åŸå› 

**æŠ€æœ¯å±‚é¢**:
```python
# update_production_order å‡½æ•°ç¼ºå°‘åŒæ­¥é€»è¾‘
async def update_production_order(db, production_id, data):
    # æ›´æ–°å·¥å•çŠ¶æ€
    production.status = "COMPLETED"
    await db.commit()

    # âŒ ç¼ºå°‘è¿™æ®µé€»è¾‘ï¼š
    # if all_productions_completed:
    #     order.status = "COMPLETED"
```

**ä¸šåŠ¡é€»è¾‘**:
- å­˜åœ¨ä¸¤ä¸ªæ›´æ–°å·¥å•çŠ¶æ€çš„æ¥å£
- `complete_production` âœ… æœ‰åŒæ­¥é€»è¾‘
- `update_production_order` âŒ æ— åŒæ­¥é€»è¾‘
- å½“ä½¿ç”¨åè€…æ—¶ï¼Œè®¢å•çŠ¶æ€ä¸ä¼šæ›´æ–°

**å…³é”®çº¿ç´¢**:
- å·¥å•å¼€å§‹å’Œå®Œæˆæ—¶é—´ç›¸åŒï¼ˆ0ç§’é—´éš”ï¼‰âš ï¸
- å®Œæˆæ•°é‡ä¸º0 âš ï¸
- è¯´æ˜å¯èƒ½ä½¿ç”¨äº†updateæ¥å£è€Œécompleteæ¥å£

#### âœ… è§£å†³æ–¹æ¡ˆ

**ä¿®å¤ä»£ç **:
```python
async def update_production_order(db, production_id, data):
    # 1. é¢„åŠ è½½è®¢å•å…³ç³»
    stmt = (
        select(ProductionOrder)
        .where(ProductionOrder.id == production_id)
        .options(selectinload(ProductionOrder.order))  # å…³é”®
    )
    production = await db.execute(stmt).scalar_one()

    # 2. è®°å½•åŸçŠ¶æ€
    old_status = production.status

    # 3. æ›´æ–°å­—æ®µ
    for key, value in data.items():
        setattr(production, key, value)

    await db.flush()

    # 4. ğŸ”‘ æ–°å¢ï¼šçŠ¶æ€å˜æ›´æ—¶åŒæ­¥è®¢å•
    if old_status != "COMPLETED" and production.status == "COMPLETED":
        # æ£€æŸ¥æ‰€æœ‰å·¥å•æ˜¯å¦éƒ½å®Œæˆ
        unfinished = await db.execute(
            select(ProductionOrder).where(
                and_(
                    ProductionOrder.order_id == production.order_id,
                    ProductionOrder.status != "COMPLETED"
                )
            )
        ).scalars().all()

        # å¦‚æœéƒ½å®Œæˆäº†ï¼Œæ›´æ–°è®¢å•çŠ¶æ€
        if not unfinished:
            production.order.status = OrderStatus.COMPLETED
            production.order.updated_at = datetime.now()

    await db.commit()
    return production
```

**ä¸´æ—¶ä¿®å¤è„šæœ¬**:
```python
# sync_order_status.py - ä¿®å¤å†å²æ•°æ®
async def sync_order_status():
    query = text("""
    SELECT o.id, o.order_no,
           COUNT(p.id) as total,
           SUM(CASE WHEN p.status='COMPLETED' THEN 1 ELSE 0 END) as completed
    FROM erp_orders o
    LEFT JOIN erp_production_orders p ON o.id = p.order_id
    WHERE o.status = 'PRODUCTION'
    GROUP BY o.id
    """)

    orders = await db.execute(query).fetchall()

    for order in orders:
        if order.total > 0 and order.completed == order.total:
            await db.execute(text("""
                UPDATE erp_orders
                SET status='COMPLETED', updated_at=NOW()
                WHERE id=:id
            """), {"id": order.id})

    await db.commit()
```

#### ğŸ’¡ å­¦ä¹ è¦ç‚¹

**æ ¸å¿ƒæ¦‚å¿µ**:
1. **åº”ç”¨å±‚æ•°æ®åŒæ­¥**
   - ä¸»è¡¨å’Œä»è¡¨çš„çŠ¶æ€éœ€è¦ä¿æŒä¸€è‡´
   - ä»è¡¨çŠ¶æ€å˜åŒ–æ—¶ï¼Œéœ€è¦æ£€æŸ¥å¹¶æ›´æ–°ä¸»è¡¨

2. **ORMå…³ç³»é¢„åŠ è½½**
   ```python
   .options(selectinload(ProductionOrder.order))
   # é¿å…N+1æŸ¥è¯¢ï¼Œæé«˜æ€§èƒ½
   ```

3. **æ•°æ®åº“äº‹åŠ¡çš„åŸå­æ€§**
   ```python
   async with db.begin():  # å¼€å¯äº‹åŠ¡
       # å¤šä¸ªæ“ä½œ
       production.status = "COMPLETED"
       order.status = "COMPLETED"
       # è¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å›æ»š
   ```

4. **flush vs commit**
   ```python
   await db.flush()   # å‘é€SQLåˆ°æ•°æ®åº“ï¼Œä½†ä¸æäº¤
                      # åŒä¸€äº‹åŠ¡å†…å¯è§ï¼Œå¯ä»¥ç»§ç»­æŸ¥è¯¢

   await db.commit()  # æäº¤äº‹åŠ¡ï¼Œæ°¸ä¹…ä¿å­˜
   ```

**è®¾è®¡æ¨¡å¼**:
- **ç»Ÿä¸€å…¥å£æ¨¡å¼**: ç›¸åŒæ“ä½œåº”è¯¥æœ‰ç»Ÿä¸€çš„å…¥å£å‡½æ•°
- **çŠ¶æ€æœºæ¨¡å¼**: çŠ¶æ€å˜æ›´åº”è¯¥æœ‰æ˜ç¡®çš„è§„åˆ™å’Œæ£€æŸ¥

**æœ€ä½³å®è·µ**:
1. âœ… çŠ¶æ€åŒæ­¥é€»è¾‘åº”è¯¥é›†ä¸­ç®¡ç†
2. âœ… ä½¿ç”¨äº‹åŠ¡ä¿è¯æ•°æ®ä¸€è‡´æ€§
3. âœ… é¢„åŠ è½½å…³è”å¯¹è±¡é¿å…æ€§èƒ½é—®é¢˜
4. âœ… è®°å½•æ“ä½œæ—¥å¿—ä¾¿äºæ’æŸ¥é—®é¢˜
5. âœ… æ·»åŠ æ•°æ®æ ¡éªŒé˜²æ­¢å¼‚å¸¸çŠ¶æ€

**é¢„é˜²æªæ–½**:
```python
# 1. APIå±‚é™åˆ¶çŠ¶æ€ä¿®æ”¹
if "status" in data and data["status"] == "COMPLETED":
    raise HTTPException(400, "è¯·ä½¿ç”¨ /complete æ¥å£å®Œæˆç”Ÿäº§")

# 2. æ·»åŠ ä¸šåŠ¡è§„åˆ™æ ¡éªŒ
if production.total_completed_quantity == 0:
    raise ValueError("å®Œæˆæ•°é‡ä¸èƒ½ä¸º0")

# 3. æ·»åŠ æ—¶é—´é—´éš”æ ¡éªŒ
if (end_time - start_time).total_seconds() < 60:
    logger.warning(f"å·¥å•{production_no}å®Œæˆè¿‡å¿«")
```

**ç›¸å…³æ–‡æ¡£**:
- [BUGFIX_ORDER_PRODUCTION_STATUS_SYNC.md](./BUGFIX_ORDER_PRODUCTION_STATUS_SYNC.md) - è¯¦ç»†ä¿®å¤è®°å½•
- [MULTI_TABLE_SYNC_EXPLAINED.md](./MULTI_TABLE_SYNC_EXPLAINED.md) - å¤šè¡¨åŒæ­¥æŠ€æœ¯è¯¦è§£
- [TIME_INTERVAL_ANALYSIS.md](./TIME_INTERVAL_ANALYSIS.md) - æ—¶é—´é—´éš”ä¸é—®é¢˜å…³ç³»åˆ†æ

**é€‚ç”¨åœºæ™¯**:
- âœ… ä¸»ä»è¡¨çŠ¶æ€åŒæ­¥
- âœ… è®¢å•-è®¢å•æ˜ç»†å…³ç³»
- âœ… æ–‡æ¡£-å®¡æ‰¹æµç¨‹å…³ç³»
- âœ… ä»»ä½•éœ€è¦èšåˆè®¡ç®—çš„åœºæ™¯

---

### 1.2 Pydanticæ¨¡å‹å®šä¹‰é—®é¢˜

#### ğŸ“‹ é—®é¢˜æè¿°

**ç°è±¡**:
```python
pydantic.errors.PydanticUserError: Error when building FieldInfo from annotated attribute.
Make sure you don't have any field name clashing with a type annotation.
```

**ä»£ç ç¤ºä¾‹**:
```python
from datetime import date

class DailyPaymentReport(BaseModel):
    date: date = Field(..., description="æ—¥æœŸ")  # âŒ å†²çªï¼
```

#### ğŸ” æ ¹æœ¬åŸå› 

**Pythonå‘½åç©ºé—´é—®é¢˜**:
```python
from datetime import date  # date æ˜¯ä¸€ä¸ªç±»å‹

class Model:
    date: date  # ç¬¬ä¸€ä¸ªdateæ˜¯å­—æ®µåï¼Œç¬¬äºŒä¸ªdateæ˜¯ç±»å‹
    # Pydanticæ— æ³•åŒºåˆ†å­—æ®µåå’Œç±»å‹å
```

**ä¸ºä»€ä¹ˆä¼šå†²çª**:
- Pydanticåœ¨è§£æå­—æ®µæ—¶ï¼Œä½¿ç”¨å­—æ®µåä½œä¸ºæ ‡è¯†ç¬¦
- å½“å­—æ®µåä¸ç±»å‹åç›¸åŒæ—¶ï¼Œäº§ç”Ÿæ­§ä¹‰
- å°¤å…¶æ˜¯åœ¨ä½¿ç”¨ `Field()` æ—¶æ›´å®¹æ˜“å‡ºé”™

#### âœ… è§£å†³æ–¹æ¡ˆ

**æ–¹æ¡ˆ1: ç±»å‹åˆ«å**
```python
from datetime import date as DateType  # âœ… é‡å‘½åç±»å‹

class DailyPaymentReport(BaseModel):
    date: DateType = Field(..., description="æ—¥æœŸ")
    # ç°åœ¨æ¸…æ™°äº†ï¼šdateæ˜¯å­—æ®µåï¼ŒDateTypeæ˜¯ç±»å‹
```

**æ–¹æ¡ˆ2: ä¿®æ”¹å­—æ®µå**
```python
from datetime import date

class DailyPaymentReport(BaseModel):
    report_date: date = Field(..., description="æ—¥æœŸ")  # âœ… æ¢ä¸ªå­—æ®µå
```

**æ–¹æ¡ˆ3: ä½¿ç”¨å­—ç¬¦ä¸²æ³¨è§£ï¼ˆPython 3.10+ï¼‰**
```python
from __future__ import annotations
from datetime import date

class DailyPaymentReport(BaseModel):
    date: "date" = Field(..., description="æ—¥æœŸ")  # âœ… å­—ç¬¦ä¸²æ³¨è§£
```

#### ğŸ’¡ å­¦ä¹ è¦ç‚¹

**Pythonç±»å‹ç³»ç»Ÿ**:
1. ç±»å‹æ³¨è§£ä¸­çš„åç§°åœ¨å½“å‰å‘½åç©ºé—´ä¸­æŸ¥æ‰¾
2. å¯¼å…¥è¯­å¥ä¼šåœ¨å½“å‰å‘½åç©ºé—´åˆ›å»ºåç§°
3. å­—æ®µå®šä¹‰æ—¶ï¼Œå­—æ®µåå’Œç±»å‹åä¸èƒ½å†²çª

**Pydanticå·¥ä½œåŸç†**:
```python
# Pydanticè§£æè¿‡ç¨‹
class Meta:
    date: date  # è§£æä¸ºï¼šå­—æ®µå="date", ç±»å‹=???
    # Pydanticå°è¯•æŸ¥æ‰¾ç±»å‹ï¼Œä½†"date"å·²ç»è¢«å­—æ®µåå ç”¨
```

**æœ€ä½³å®è·µ**:
1. âœ… å¯¼å…¥ç±»å‹æ—¶ä½¿ç”¨åˆ«åï¼ˆå°¤å…¶æ˜¯å¸¸è§åç§°ï¼‰
2. âœ… å­—æ®µåä½¿ç”¨æè¿°æ€§åç§°ï¼ˆå¦‚ `created_date`ï¼‰
3. âœ… é¿å…ä½¿ç”¨Pythonå†…ç½®ç±»å‹åä½œä¸ºå­—æ®µå
4. âœ… ç»Ÿä¸€å›¢é˜Ÿçš„å‘½åè§„èŒƒ

**å¸¸è§å†²çªç±»å‹**:
```python
# å®¹æ˜“å†²çªçš„ç±»å‹å
from datetime import date, time, datetime
from typing import List, Dict, Set

# å»ºè®®çš„å¯¼å…¥æ–¹å¼
from datetime import date as DateType
from datetime import time as TimeType
from datetime import datetime as DateTimeType
from typing import List as ListType  # æˆ–è€…ç›´æ¥ç”¨ list (Python 3.9+)
```

**Pydantic V2 vs V1 å·®å¼‚**:
```python
# Pydantic V1
class Config:
    orm_mode = True

# Pydantic V2 (æœ¬é¡¹ç›®ä½¿ç”¨)
model_config = ConfigDict(from_attributes=True)
```

---

### 1.3 æ¨¡å—å¯¼å…¥ä¸ä¾èµ–ç®¡ç†

#### ğŸ“‹ é—®é¢˜æè¿°

**ç°è±¡**:
```python
ImportError: cannot import name 'get_current_user' from 'app.api.v1.endpoints.auth'
```

**é”™è¯¯ä»£ç **:
```python
# reports.py
from app.api.v1.endpoints.auth import get_current_user  # âŒ é”™è¯¯è·¯å¾„
```

#### ğŸ” æ ¹æœ¬åŸå› 

**æ¨¡å—ç»„ç»‡é—®é¢˜**:
```
app/
â”œâ”€â”€ api/
â”‚   â”œâ”€â”€ deps.py              â† get_current_user å®é™…ä½ç½® âœ…
â”‚   â””â”€â”€ v1/
â”‚       â””â”€â”€ endpoints/
â”‚           â””â”€â”€ auth.py      â† ä»¥ä¸ºåœ¨è¿™é‡Œ âŒ
```

**ä¸ºä»€ä¹ˆå®¹æ˜“å‡ºé”™**:
1. å‡½æ•°åå…·æœ‰è¯¯å¯¼æ€§ï¼ˆ`get_current_user` å¬èµ·æ¥åº”è¯¥åœ¨auth.pyï¼‰
2. æ²¡æœ‰IDEæ™ºèƒ½æç¤ºæ—¶å®¹æ˜“çŒœé”™è·¯å¾„
3. å¤šä¸ªæ¨¡å—å¯èƒ½æœ‰ç›¸ä¼¼çš„å‡½æ•°å

#### âœ… è§£å†³æ–¹æ¡ˆ

**æ­£ç¡®çš„å¯¼å…¥**:
```python
# âœ… æ­£ç¡®
from app.api.deps import get_current_user

# âŒ é”™è¯¯
from app.api.v1.endpoints.auth import get_current_user
```

**é¡¹ç›®ç»“æ„è¯´æ˜**:
```python
# app/api/deps.py - ä¾èµ–æ³¨å…¥å‡½æ•°
async def get_current_user(...):
    """è·å–å½“å‰ç™»å½•ç”¨æˆ·ï¼ˆä¾èµ–æ³¨å…¥ï¼‰"""
    pass

async def get_db():
    """è·å–æ•°æ®åº“ä¼šè¯ï¼ˆä¾èµ–æ³¨å…¥ï¼‰"""
    pass

# app/api/v1/endpoints/auth.py - è®¤è¯æ¥å£
@router.post("/login")
async def login(...):
    """ç™»å½•æ¥å£"""
    pass
```

#### ğŸ’¡ å­¦ä¹ è¦ç‚¹

**Pythonæ¨¡å—ç³»ç»Ÿ**:
1. **ç»å¯¹å¯¼å…¥ vs ç›¸å¯¹å¯¼å…¥**
   ```python
   # ç»å¯¹å¯¼å…¥ï¼ˆæ¨èï¼‰
   from app.api.deps import get_current_user

   # ç›¸å¯¹å¯¼å…¥
   from ..deps import get_current_user  # ä»ä¸Šçº§ç›®å½•
   from .auth import login              # ä»åŒçº§ç›®å½•
   ```

2. **å¾ªç¯å¯¼å…¥é—®é¢˜**
   ```python
   # âŒ ä¼šå¯¼è‡´å¾ªç¯å¯¼å…¥
   # a.py
   from b import foo

   # b.py
   from a import bar

   # âœ… è§£å†³æ–¹æ³•ï¼šä½¿ç”¨ä¾èµ–æ³¨å…¥æˆ–å»¶è¿Ÿå¯¼å…¥
   # a.py
   def get_foo():
       from b import foo  # å‡½æ•°å†…å¯¼å…¥
       return foo
   ```

**FastAPIä¾èµ–æ³¨å…¥æ¨¡å¼**:
```python
# deps.py - é›†ä¸­ç®¡ç†ä¾èµ–
async def get_db() -> AsyncGenerator:
    """æ•°æ®åº“ä¼šè¯ä¾èµ–"""
    async with AsyncSessionLocal() as session:
        yield session

async def get_current_user(
    db: AsyncSession = Depends(get_db),
    token: str = Depends(oauth2_scheme)
) -> User:
    """å½“å‰ç”¨æˆ·ä¾èµ–"""
    # éªŒè¯tokenå¹¶è¿”å›ç”¨æˆ·
    pass

# endpoints/users.py - ä½¿ç”¨ä¾èµ–
@router.get("/me")
async def get_me(
    current_user: User = Depends(get_current_user)  # âœ… æ³¨å…¥ä¾èµ–
):
    return current_user
```

**æœ€ä½³å®è·µ**:
1. âœ… ä½¿ç”¨ç»å¯¹å¯¼å…¥ï¼Œè·¯å¾„æ¸…æ™°
2. âœ… ä¾èµ–æ³¨å…¥å‡½æ•°æ”¾åœ¨ `deps.py`
3. âœ… ä¸šåŠ¡é€»è¾‘æ”¾åœ¨ `services/`
4. âœ… APIç«¯ç‚¹æ”¾åœ¨ `endpoints/`
5. âœ… ä½¿ç”¨IDEçš„è‡ªåŠ¨å¯¼å…¥åŠŸèƒ½
6. âœ… å®šæœŸæ£€æŸ¥å’Œæ¸…ç†æœªä½¿ç”¨çš„å¯¼å…¥

**è°ƒè¯•æŠ€å·§**:
```python
# 1. æ‰“å°æ¨¡å—è·¯å¾„
import app.api.deps
print(app.api.deps.__file__)  # æŸ¥çœ‹æ¨¡å—å®é™…ä½ç½®

# 2. æŸ¥çœ‹æ¨¡å—å†…å®¹
print(dir(app.api.deps))  # åˆ—å‡ºæ¨¡å—æ‰€æœ‰å¯¼å‡ºå†…å®¹

# 3. ä½¿ç”¨ __all__ æ˜ç¡®å¯¼å‡º
# deps.py
__all__ = ["get_db", "get_current_user"]
```

---

### 1.4 æ•°æ®åº“ä¼šè¯ä¸äº‹åŠ¡ç®¡ç†

#### ğŸ“‹ é—®é¢˜æè¿°

**ç°è±¡**:
```python
RuntimeError: Event loop is closed
sqlalchemy.exc.InvalidRequestError: This session is already closed
```

**å¸¸è§é”™è¯¯**:
```python
# âŒ é”™è¯¯ç¤ºä¾‹1ï¼šå¿˜è®°ä½¿ç”¨async/await
def get_order(db, order_id):  # å°‘äº†async
    result = db.execute(select(Order))  # å°‘äº†await
    return result.scalar_one()

# âŒ é”™è¯¯ç¤ºä¾‹2ï¼šäº‹åŠ¡æœªæäº¤
async def update_order(db, order_id, data):
    order.status = "COMPLETED"
    # å¿˜è®° await db.commit()
```

#### ğŸ” æ ¹æœ¬åŸå› 

**SQLAlchemy 2.0 å¼‚æ­¥æ¨¡å¼**:
```python
# SQLAlchemy 2.0 ä½¿ç”¨å¼‚æ­¥å¼•æ“
engine = create_async_engine("mysql+aiomysql://...")

# æ‰€æœ‰æ•°æ®åº“æ“ä½œéƒ½å¿…é¡»æ˜¯å¼‚æ­¥çš„
async with AsyncSessionLocal() as session:
    result = await session.execute(...)  # å¿…é¡»await
    await session.commit()               # å¿…é¡»await
```

**äº‹åŠ¡ç®¡ç†é—®é¢˜**:
- é»˜è®¤ä¸è‡ªåŠ¨æäº¤ï¼ˆautocommit=Falseï¼‰
- å¿…é¡»æ˜¾å¼è°ƒç”¨ `commit()` æˆ–ä½¿ç”¨ä¸Šä¸‹æ–‡ç®¡ç†å™¨
- å¼‚å¸¸æ—¶éœ€è¦ `rollback()`

#### âœ… è§£å†³æ–¹æ¡ˆ

**æ­£ç¡®çš„ä¼šè¯ä½¿ç”¨**:
```python
# âœ… æ–¹æ¡ˆ1ï¼šä½¿ç”¨FastAPIä¾èµ–æ³¨å…¥ï¼ˆæ¨èï¼‰
from app.api.deps import get_db

@router.post("/orders")
async def create_order(
    data: OrderCreate,
    db: AsyncSession = Depends(get_db)  # è‡ªåŠ¨ç®¡ç†ä¼šè¯
):
    order = Order(**data.dict())
    db.add(order)
    await db.commit()  # deps.pyä¼šè‡ªåŠ¨å¤„ç†å¼‚å¸¸å›æ»š
    await db.refresh(order)
    return order

# âœ… æ–¹æ¡ˆ2ï¼šæ‰‹åŠ¨ç®¡ç†ä¼šè¯ï¼ˆè„šæœ¬/æµ‹è¯•ï¼‰
async def my_script():
    async with AsyncSessionLocal() as session:
        try:
            # æ•°æ®åº“æ“ä½œ
            order = Order(...)
            session.add(order)
            await session.commit()
        except Exception as e:
            await session.rollback()
            raise
        finally:
            await session.close()
```

**äº‹åŠ¡æ¨¡å¼**:
```python
# 1. æ˜¾å¼äº‹åŠ¡
async with db.begin():
    # æ‰€æœ‰æ“ä½œåœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­
    db.add(order)
    db.add(payment)
    # é€€å‡ºæ—¶è‡ªåŠ¨commitæˆ–rollback

# 2. åµŒå¥—äº‹åŠ¡ï¼ˆä¿å­˜ç‚¹ï¼‰
async with db.begin():
    db.add(order)

    async with db.begin_nested():  # SAVEPOINT
        db.add(payment)
        # è¿™é‡Œå¯ä»¥ç‹¬ç«‹å›æ»š

    await db.commit()

# 3. æ‰‹åŠ¨æ§åˆ¶
db.add(order)
await db.flush()    # å‘é€SQLä½†ä¸æäº¤
await db.commit()   # æäº¤äº‹åŠ¡
```

#### ğŸ’¡ å­¦ä¹ è¦ç‚¹

**å¼‚æ­¥ç¼–ç¨‹åŸºç¡€**:
```python
# 1. async/await è¯­æ³•
async def func():      # å®šä¹‰åç¨‹å‡½æ•°
    await operation()  # ç­‰å¾…å¼‚æ­¥æ“ä½œ

# 2. äº‹ä»¶å¾ªç¯
asyncio.run(main())    # è¿è¡Œåç¨‹

# 3. å¼‚æ­¥ä¸Šä¸‹æ–‡ç®¡ç†å™¨
async with resource:
    # ä½¿ç”¨èµ„æº
```

**SQLAlchemyä¼šè¯ç”Ÿå‘½å‘¨æœŸ**:
```
1. åˆ›å»ºä¼šè¯ â†’ AsyncSessionLocal()
2. æ‰§è¡Œæ“ä½œ â†’ execute(), add(), delete()
3. åˆ·æ–°ç¼“å­˜ â†’ flush() [å¯é€‰]
4. æäº¤äº‹åŠ¡ â†’ commit()
5. å…³é—­ä¼šè¯ â†’ close()
```

**æœ€ä½³å®è·µ**:
```python
# âœ… å¥½çš„åšæ³•
async def service_function(db: AsyncSession, data):
    """æœåŠ¡å±‚å‡½æ•°ï¼Œæ¥æ”¶ä¼šè¯ä½œä¸ºå‚æ•°"""
    obj = Model(**data)
    db.add(obj)
    await db.commit()
    await db.refresh(obj)
    return obj

# âŒ ä¸å¥½çš„åšæ³•
async def service_function(data):
    """åœ¨å‡½æ•°å†…éƒ¨åˆ›å»ºä¼šè¯"""
    async with AsyncSessionLocal() as db:  # âŒ éš¾ä»¥æµ‹è¯•
        obj = Model(**data)
        db.add(obj)
        await db.commit()
        return obj
```

**å¸¸è§é”™è¯¯ä¸è§£å†³**:
```python
# é”™è¯¯1ï¼šå¿˜è®°await
result = db.execute(stmt)  # âŒ
result = await db.execute(stmt)  # âœ…

# é”™è¯¯2ï¼šåœ¨åŒæ­¥å‡½æ•°ä¸­ä½¿ç”¨å¼‚æ­¥ä¼šè¯
def sync_func():
    result = await db.execute(stmt)  # âŒ SyntaxError

async def async_func():
    result = await db.execute(stmt)  # âœ…

# é”™è¯¯3ï¼šä¼šè¯æ³„æ¼
session = AsyncSessionLocal()
# ... æ“ä½œ ...
# âŒ å¿˜è®°å…³é—­ä¼šè¯

# âœ… ä½¿ç”¨ä¸Šä¸‹æ–‡ç®¡ç†å™¨
async with AsyncSessionLocal() as session:
    # è‡ªåŠ¨å…³é—­
    pass
```

**è°ƒè¯•æŠ€å·§**:
```python
# 1. æ‰“å°SQLè¯­å¥
engine = create_async_engine(..., echo=True)  # æ‰“å°æ‰€æœ‰SQL

# 2. æ£€æŸ¥ä¼šè¯çŠ¶æ€
print(session.is_active)   # æ˜¯å¦æ´»è·ƒ
print(session.dirty)       # è„å¯¹è±¡ï¼ˆæœªæäº¤çš„ä¿®æ”¹ï¼‰
print(session.new)         # æ–°å¯¹è±¡ï¼ˆæœªä¿å­˜ï¼‰

# 3. ä½¿ç”¨æ—¥å¿—
import logging
logging.getLogger('sqlalchemy.engine').setLevel(logging.INFO)
```

---

### 1.5 PDFç”Ÿæˆä¸æ–‡ä»¶ä¸‹è½½é—®é¢˜

#### ğŸ“‹ é—®é¢˜æè¿°

**ç°è±¡**:
```python
# åç«¯è¿”å›500é”™è¯¯
{"detail": "ç”ŸæˆPDFå¤±è´¥: 'ProductionOrder' object has no attribute 'work_order_no'"}

# æ•°æ®åº“æŸ¥è¯¢æˆåŠŸä½†PDFç”Ÿæˆæ—¶ROLLBACK
sqlalchemy.exc.InvalidRequestError: When initializing mapper Mapper[Order(erp_orders)],
expression 'Customer' failed to locate a name ('Customer')
```

**å…·ä½“è¡¨ç°**:
- âœ… é”€å”®è®¢å•PDFã€é€è´§å•PDFä¸‹è½½æˆåŠŸ
- âŒ ç”Ÿäº§å·¥å•PDFè¿”å›500é”™è¯¯
- âœ… ç‹¬ç«‹Pythonè„šæœ¬æµ‹è¯•PDFç”ŸæˆæˆåŠŸï¼ˆ63888å­—èŠ‚ï¼‰
- âŒ é€šè¿‡Web APIè°ƒç”¨å¤±è´¥ï¼ŒæŠ¥å­—æ®µåé”™è¯¯
- æ•°æ®åº“æŸ¥è¯¢æ­£å¸¸æ‰§è¡Œï¼Œä½†åœ¨PDFæ„å»ºé˜¶æ®µROLLBACK

#### ğŸ” æ ¹æœ¬åŸå› 

**é—®é¢˜1: SQLAlchemyå…³ç³»é…ç½®ç¼ºå°‘æ¨¡å‹å¯¼å…¥**

```python
# pdf_service.py åŸå§‹ä»£ç 
from app.models.order import Order  # âœ… å¯¼å…¥äº†Order
from app.models.production import ProductionOrder  # âœ… å¯¼å…¥äº†ProductionOrder

# âŒ ä½†æ˜¯Orderæ¨¡å‹ä¸­å®šä¹‰äº†ä¸Customerçš„å…³ç³»
class Order(Base):
    customer: Mapped[Optional["Customer"]] = relationship(
        "Customer", back_populates="orders"
    )
    # SQLAlchemyåœ¨é…ç½®mapperæ—¶æ‰¾ä¸åˆ°Customerç±»
```

**ä¸ºä»€ä¹ˆä¼šå‡ºé”™**:
- SQLAlchemyä½¿ç”¨å»¶è¿Ÿé…ç½®ï¼ˆlazy configurationï¼‰
- å½“è®¿é—®Order.itemså…³ç³»æ—¶ï¼Œè§¦å‘mapperé…ç½®
- é…ç½®è¿‡ç¨‹ä¸­éœ€è¦è§£ææ‰€æœ‰relationshipå¼•ç”¨çš„ç±»
- å¦‚æœå¼•ç”¨çš„ç±»ï¼ˆCustomerã€Materialã€Userç­‰ï¼‰æœªè¢«å¯¼å…¥ï¼Œé…ç½®å¤±è´¥

**é—®é¢˜2: æ•°æ®åº“å­—æ®µåä¸ä»£ç ä¸åŒ¹é…**

```python
# Orderæ¨¡å‹å®šä¹‰
class Order(Base):
    contact_phone: Mapped[Optional[str]] = mapped_column(...)  # âœ… æ­£ç¡®å­—æ®µå
    remark: Mapped[Optional[str]] = mapped_column(...)         # âœ… æ­£ç¡®å­—æ®µå

# PDFä»£ç é”™è¯¯ä½¿ç”¨
order_info = {
    "è”ç³»ç”µè¯:": order.customer_phone,  # âŒ åº”è¯¥æ˜¯ contact_phone
    "å¤‡æ³¨:": order.notes               # âŒ åº”è¯¥æ˜¯ remark
}

# ProductionOrderæ¨¡å‹å®šä¹‰
class ProductionOrder(Base):
    production_no: Mapped[str] = mapped_column(...)  # âœ… æ­£ç¡®å­—æ®µå

# PDFä»£ç é”™è¯¯ä½¿ç”¨
production_info = {
    "å·¥å•ç¼–å·:": production.work_order_no  # âŒ åº”è¯¥æ˜¯ production_no
}
```

**é—®é¢˜3: Pythonæ¨¡å—ç¼“å­˜æœªæ¸…ç†**

```
åŸå› åˆ†æï¼š
1. ä¿®å¤ä»£ç åï¼Œ.pycå­—èŠ‚ç æ–‡ä»¶ä»æ˜¯æ—§ç‰ˆæœ¬
2. uvicorn --reload åªç›‘æ§.pyæ–‡ä»¶ä¿®æ”¹
3. å¦‚æœ.pyæ—¶é—´æˆ³æœªå˜åŒ–ï¼Œä¸ä¼šé‡æ–°åŠ è½½æ¨¡å—
4. __pycache__ç›®å½•ä¸­çš„.pycä¼˜å…ˆè¢«Pythonè§£é‡Šå™¨ä½¿ç”¨
5. å¯¼è‡´ä¿®å¤åçš„ä»£ç æ²¡æœ‰ç”Ÿæ•ˆ

éªŒè¯æ–¹æ³•ï¼š
- âœ… ç‹¬ç«‹Pythonè„šæœ¬æµ‹è¯•æˆåŠŸï¼ˆé‡æ–°å¯¼å…¥æ¨¡å—ï¼‰
- âŒ Web APIè°ƒç”¨å¤±è´¥ï¼ˆä½¿ç”¨ç¼“å­˜çš„æ—§æ¨¡å—ï¼‰
```

#### âœ… è§£å†³æ–¹æ¡ˆ

**æ­¥éª¤1: æ·»åŠ æ‰€æœ‰å¿…éœ€çš„æ¨¡å‹å¯¼å…¥**

```python
# backend/app/services/pdf_service.py
from app.utils.pdf_generator import PDFGenerator

# âœ… å¯¼å…¥æ‰€æœ‰åœ¨å…³ç³»ä¸­å¼•ç”¨çš„æ¨¡å‹
from app.models.user import User                    # ProductionReportå¼•ç”¨
from app.models.order import Order, OrderItem       # ä¸»è¦ä¸šåŠ¡æ¨¡å‹
from app.models.production import (                 # ç”Ÿäº§ç›¸å…³
    ProductionOrder,
    ProductionOrderItem,
    ProductionReport
)
from app.models.payment import OrderPayment         # æ”¶æ¬¾ç›¸å…³
from app.models.customer import Customer            # Orderå¼•ç”¨
from app.models.material import Material            # OrderItemå¼•ç”¨

# å…³é”®ï¼šå³ä½¿Serviceä¸ç›´æ¥ä½¿ç”¨è¿™äº›æ¨¡å‹ï¼Œ
# åªè¦å…³ç³»ä¸­å¼•ç”¨äº†ï¼Œå°±å¿…é¡»å¯¼å…¥
```

**æ­¥éª¤2: ä¿®æ­£æ‰€æœ‰å­—æ®µåé”™è¯¯**

```python
# ä¿®å¤Orderç›¸å…³å­—æ®µ
order_info = {
    "è”ç³»äºº:": order.contact_person or "æœªå¡«å†™",      # âœ… ä¿®æ­£
    "è”ç³»ç”µè¯:": order.contact_phone or "æœªå¡«å†™",     # âœ… ä¿®æ­£
    "è®¢å•æ—¥æœŸ:": generator.format_date(order.created_at),
    "è®¢å•çŠ¶æ€:": status_map.get(order.status),
}

# ä¿®å¤å¤‡æ³¨å­—æ®µï¼ˆæ‰€æœ‰æ¨¡å‹ç»Ÿä¸€ä½¿ç”¨remarkï¼‰
if order.remark:                                     # âœ… ä¿®æ­£
    notes = Paragraph(f"<b>å¤‡æ³¨:</b> {order.remark}")

if production.remark:                                # âœ… ä¿®æ­£
    notes = Paragraph(f"<b>å¤‡æ³¨:</b> {production.remark}")

if payment.remark:                                   # âœ… ä¿®æ­£
    notes = Paragraph(f"<b>å¤‡æ³¨:</b> {payment.remark}")

# ä¿®å¤ç”Ÿäº§å·¥å•å­—æ®µ
production_info = {
    "å·¥å•ç¼–å·:": production.production_no,           # âœ… ä¿®æ­£
    "è®¡åˆ’å¼€å§‹:": generator.format_date(production.plan_start_date),  # âœ… ä¿®æ­£
    "è®¡åˆ’å®Œæˆ:": generator.format_date(production.plan_end_date),    # âœ… ä¿®æ­£
}
```

**æ­¥éª¤3: å½»åº•æ¸…ç†Pythonç¼“å­˜**

```bash
# Windows (PowerShell/CMD)
# æ–¹æ³•1: æ‰‹åŠ¨åˆ é™¤ç¼“å­˜
cd backend
del /s /q *.pyc
for /d /r . %d in (__pycache__) do @if exist "%d" rd /s /q "%d"

# æ–¹æ³•2: ä½¿ç”¨findå‘½ä»¤ (Git Bash)
find backend -type f -name "*.pyc" -delete
find backend -type d -name "__pycache__" -exec rm -rf {} +

# æ–¹æ³•3: Pythonè„šæœ¬
python -c "import pathlib; [p.unlink() for p in pathlib.Path('backend').rglob('*.pyc')]"

# Linux/Mac
find backend -name "*.pyc" -delete
find backend -type d -name "__pycache__" -exec rm -rf {} +

# é‡å¯åç«¯æœåŠ¡
cd backend && poetry run uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

**æ­¥éª¤4: éªŒè¯ä¿®å¤**

```python
# ç‹¬ç«‹æµ‹è¯•è„šæœ¬ - éªŒè¯æ ¸å¿ƒé€»è¾‘
cd backend && poetry run python << 'EOF'
import asyncio
from sqlalchemy.ext.asyncio import create_async_engine, AsyncSession
from sqlalchemy.orm import sessionmaker
from app.core.config import settings
from app.services.pdf_service import PrintService

async def test():
    engine = create_async_engine(settings.DATABASE_URL, echo=False)
    async_session = sessionmaker(engine, class_=AsyncSession, expire_on_commit=False)

    async with async_session() as session:
        # æµ‹è¯•æ‰€æœ‰PDFç±»å‹
        order_pdf = await PrintService.generate_order_pdf(session, 6)
        production_pdf = await PrintService.generate_production_pdf(session, 4)
        delivery_pdf = await PrintService.generate_delivery_pdf(session, 6)

        print(f"âœ… Order PDF: {len(order_pdf.getvalue())} bytes")
        print(f"âœ… Production PDF: {len(production_pdf.getvalue())} bytes")
        print(f"âœ… Delivery PDF: {len(delivery_pdf.getvalue())} bytes")

asyncio.run(test())
EOF

# APIæµ‹è¯• - éªŒè¯Webæ¥å£
curl -X POST http://localhost:8000/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}' | jq -r '.data.access_token' > token.txt

TOKEN=$(cat token.txt)

# æµ‹è¯•å„ç±»PDFä¸‹è½½
curl -X GET "http://localhost:8000/api/v1/print/order/6" \
  -H "Authorization: Bearer $TOKEN" -o order.pdf
curl -X GET "http://localhost:8000/api/v1/print/production/4" \
  -H "Authorization: Bearer $TOKEN" -o production.pdf
curl -X GET "http://localhost:8000/api/v1/print/delivery/6" \
  -H "Authorization: Bearer $TOKEN" -o delivery.pdf

# éªŒè¯æ–‡ä»¶
file order.pdf production.pdf delivery.pdf
# è¾“å‡ºåº”è¯¥æ˜¾ç¤º: PDF document, version 1.4
```

#### ğŸ’¡ å­¦ä¹ è¦ç‚¹

**1. SQLAlchemyå…³ç³»é…ç½®çš„ä¼ é€’ä¾èµ–**

```python
# é—®é¢˜æ ¹æº
class Order(Base):
    customer: Mapped["Customer"] = relationship(...)  # å¼•ç”¨Customer

class OrderItem(Base):
    paper_material: Mapped["Material"] = relationship(...)  # å¼•ç”¨Material

class ProductionOrder(Base):
    order: Mapped["Order"] = relationship(...)  # å¼•ç”¨Order

# å½“ä½ å¯¼å…¥ProductionOrderå¹¶è®¿é—®å…¶å…³ç³»æ—¶ï¼š
from app.models.production import ProductionOrder

stmt = select(ProductionOrder).options(
    selectinload(ProductionOrder.order)  # è§¦å‘Orderçš„mapperé…ç½®
)
# Orderçš„mapperé…ç½®éœ€è¦Customerå’ŒMaterial
# å¦‚æœè¿™äº›ç±»æœªå¯¼å…¥ï¼Œå°±ä¼šæŠ¥é”™
```

**è§£å†³æ–¹æ¡ˆ**:
```python
# âœ… æ–¹æ¡ˆ1: å¯¼å…¥æ‰€æœ‰ç›¸å…³æ¨¡å‹ï¼ˆæ¨èï¼‰
from app.models.user import User
from app.models.customer import Customer
from app.models.material import Material
from app.models.order import Order, OrderItem
from app.models.production import ProductionOrder, ProductionOrderItem

# âœ… æ–¹æ¡ˆ2: ä½¿ç”¨app.db.baseç»Ÿä¸€å¯¼å…¥
from app.db.base import *  # base.pyå·²å¯¼å…¥æ‰€æœ‰æ¨¡å‹

# âœ… æ–¹æ¡ˆ3: å»¶è¿Ÿå¯¼å…¥ï¼ˆä¸æ¨èï¼Œä¼šé™ä½æ€§èƒ½ï¼‰
def generate_pdf():
    from app.models.order import Order  # å‡½æ•°å†…å¯¼å…¥
```

**2. æ•°æ®åº“æ¨¡å‹å­—æ®µå‘½åè§„èŒƒ**

```python
# âœ… æ¨èçš„å‘½åæ¨¡å¼
class Order(Base):
    # è”ç³»ä¿¡æ¯ä½¿ç”¨ contact_ å‰ç¼€
    contact_person: Mapped[str] = mapped_column(...)
    contact_phone: Mapped[str] = mapped_column(...)
    contact_address: Mapped[str] = mapped_column(...)

    # æ—¶é—´å­—æ®µä½¿ç”¨æ˜ç¡®çš„åç¼€
    created_at: Mapped[datetime] = mapped_column(...)
    updated_at: Mapped[datetime] = mapped_column(...)
    plan_start_date: Mapped[datetime] = mapped_column(...)  # æ˜ç¡®æ˜¯"æ—¥æœŸ"

    # å¤‡æ³¨ç»Ÿä¸€ä½¿ç”¨ remark
    remark: Mapped[str] = mapped_column(...)  # ä¸è¦ç”¨notes/comment/description

    # ç¼–å·å­—æ®µç»Ÿä¸€åç¼€
    order_no: Mapped[str] = mapped_column(...)      # è®¢å•å·
    production_no: Mapped[str] = mapped_column(...) # ç”Ÿäº§å·¥å•å·
    payment_no: Mapped[str] = mapped_column(...)    # æ”¶æ¬¾å•å·

# âŒ é¿å…çš„å‘½åæ–¹å¼
class BadModel(Base):
    phone: Mapped[str]        # ä¸æ˜ç¡®ï¼Œå“ªä¸ªç”µè¯ï¼Ÿ
    address: Mapped[str]      # ä¸æ˜ç¡®ï¼Œå“ªä¸ªåœ°å€ï¼Ÿ
    date: Mapped[datetime]    # ä¸æ˜ç¡®ï¼Œä»€ä¹ˆæ—¥æœŸï¼Ÿ
    notes: Mapped[str]        # ä¸noteå®¹æ˜“æ··æ·†
    id_no: Mapped[str]        # ç¼–å·å‘½åä¸ç»Ÿä¸€
```

**3. Pythonå­—èŠ‚ç ç¼“å­˜æœºåˆ¶**

```python
# Pythonæ¨¡å—å¯¼å…¥æµç¨‹
1. æ£€æŸ¥ sys.modulesï¼ˆå†…å­˜ç¼“å­˜ï¼‰
2. å¦‚æœæœªç¼“å­˜ï¼ŒæŸ¥æ‰¾.pyæ–‡ä»¶
3. æ£€æŸ¥æ˜¯å¦æœ‰å¯¹åº”çš„.pycæ–‡ä»¶ä¸”æ—¶é—´æˆ³æ›´æ–°
4. å¦‚æœ.pycæœ‰æ•ˆï¼Œç›´æ¥åŠ è½½å­—èŠ‚ç 
5. å¦åˆ™ç¼–è¯‘.pyç”Ÿæˆæ–°çš„.pyc

# é—®é¢˜åœºæ™¯
1. ä¿®æ”¹äº† pdf_service.py
2. ä½† __pycache__/pdf_service.cpython-311.pyc ä»æ˜¯æ—§çš„
3. uvicorn --reload æ£€æµ‹åˆ°.pyæ–‡ä»¶å˜åŒ–
4. ä½†å¦‚æœæ—¶é—´æˆ³åˆ¤æ–­æœ‰è¯¯ï¼Œå¯èƒ½ä½¿ç”¨æ—§çš„.pyc

# å½»åº•è§£å†³æ–¹æ¡ˆ
# åˆ é™¤æ‰€æœ‰.pycå’Œ__pycache__
find . -type f -name "*.pyc" -delete
find . -type d -name "__pycache__" -delete

# Pythonå¯åŠ¨æ—¶ä¸ç”Ÿæˆ.pycï¼ˆå¼€å‘ç¯å¢ƒï¼‰
PYTHONDONTWRITEBYTECODE=1 python app.py

# æˆ–åœ¨ä»£ç ä¸­è®¾ç½®
import sys
sys.dont_write_bytecode = True
```

**4. è¯Šæ–­æ–¹æ³•ï¼šç‹¬ç«‹æµ‹è¯• vs APIæµ‹è¯•**

```python
# è¯Šæ–­ç­–ç•¥
é—®é¢˜ç°è±¡ï¼šAPIè¿”å›é”™è¯¯ï¼Œä½†ä¸ç¡®å®šæ˜¯å“ªé‡Œçš„é—®é¢˜

æ­¥éª¤1: ç‹¬ç«‹æµ‹è¯•æ ¸å¿ƒé€»è¾‘
â†’ å¦‚æœæˆåŠŸï¼šé—®é¢˜åœ¨APIå±‚ï¼ˆè·¯ç”±/ä¾èµ–æ³¨å…¥/ä¸­é—´ä»¶ï¼‰
â†’ å¦‚æœå¤±è´¥ï¼šé—®é¢˜åœ¨ä¸šåŠ¡é€»è¾‘å±‚

æ­¥éª¤2: æ£€æŸ¥æ¨¡å—å¯¼å…¥
â†’ åœ¨ç‹¬ç«‹è„šæœ¬ä¸­ from app.services import pdf_service
â†’ è§‚å¯Ÿæ˜¯å¦æœ‰å¯¼å…¥é”™è¯¯

æ­¥éª¤3: å¯¹æ¯”ç¯å¢ƒå·®å¼‚
â†’ ç‹¬ç«‹è„šæœ¬ï¼šå…¨æ–°Pythonè¿›ç¨‹ï¼Œé‡æ–°å¯¼å…¥æ‰€æœ‰æ¨¡å—
â†’ APIæœåŠ¡ï¼šå¯èƒ½ä½¿ç”¨ç¼“å­˜çš„æ—§æ¨¡å—

æ­¥éª¤4: æ¸…ç†ç¼“å­˜é‡è¯•
â†’ åˆ é™¤__pycache__
â†’ é‡å¯æœåŠ¡å™¨
â†’ å†æ¬¡æµ‹è¯•API

# å®é™…æ¡ˆä¾‹
âœ… ç‹¬ç«‹æµ‹è¯•: SUCCESS! PDF size: 63888 bytes
âŒ APIæµ‹è¯•: {"detail": "...work_order_no..."}
â†’ ç»“è®º: ä»£ç å·²ä¿®å¤ï¼Œä½†æœåŠ¡å™¨ä½¿ç”¨æ—§ä»£ç 
â†’ è§£å†³: æ¸…ç†ç¼“å­˜ + é‡å¯æœåŠ¡å™¨
```

**5. FastAPI StreamingResponseæ–‡ä»¶ä¸‹è½½**

```python
# æ­£ç¡®çš„PDFè¿”å›æ–¹å¼
@router.get("/order/{order_id}")
async def download_pdf(order_id: int, db: AsyncSession = Depends(get_db)):
    try:
        # 1. ç”ŸæˆPDFï¼ˆè¿”å›BytesIOå¯¹è±¡ï¼‰
        pdf_buffer = await PrintService.generate_order_pdf(db, order_id)

        # 2. è¿”å›æµå¼å“åº”
        return StreamingResponse(
            pdf_buffer,                              # BytesIOå¯¹è±¡
            media_type="application/pdf",            # MIMEç±»å‹
            headers={
                "Content-Disposition": f"attachment; filename=order_{order_id}.pdf"
                # attachment: æµè§ˆå™¨ä¸‹è½½
                # inline: æµè§ˆå™¨é¢„è§ˆ
            }
        )
    except ValueError as e:
        # ä¸šåŠ¡å¼‚å¸¸ï¼ˆå¦‚è®¢å•ä¸å­˜åœ¨ï¼‰
        raise HTTPException(status_code=404, detail=str(e))
    except Exception as e:
        # ç³»ç»Ÿå¼‚å¸¸
        raise HTTPException(status_code=500, detail=f"ç”ŸæˆPDFå¤±è´¥: {str(e)}")

# å‰ç«¯ä¸‹è½½å¤„ç†
async function downloadPDF(orderId) {
    const response = await axios.get(`/api/v1/print/order/${orderId}`, {
        responseType: 'blob'  // âœ… å…³é”®ï¼šæŒ‡å®šå“åº”ç±»å‹ä¸ºblob
    })

    // åˆ›å»ºä¸‹è½½é“¾æ¥
    const url = window.URL.createObjectURL(new Blob([response.data]))
    const link = document.createElement('a')
    link.href = url
    link.setAttribute('download', `è®¢å•_${orderId}.pdf`)
    document.body.appendChild(link)
    link.click()
    link.remove()
    window.URL.revokeObjectURL(url)  // âœ… æ¸…ç†å†…å­˜
}
```

**6. reportlabä¸­æ–‡å­—ä½“é…ç½®**

```python
# ä¸­æ–‡å­—ä½“æ³¨å†Œï¼ˆWindowsï¼‰
from reportlab.pdfbase import pdfmetrics
from reportlab.pdfbase.ttfonts import TTFont

try:
    # Windowsç³»ç»Ÿå­—ä½“è·¯å¾„
    pdfmetrics.registerFont(TTFont('msyh', 'C:\\Windows\\Fonts\\msyh.ttc'))
    pdfmetrics.registerFont(TTFont('msyhbd', 'C:\\Windows\\Fonts\\msyhbd.ttc'))
    font_name = 'msyh'
    font_bold = 'msyhbd'
except:
    try:
        # å¤‡é€‰ï¼šå®‹ä½“
        pdfmetrics.registerFont(TTFont('simsun', 'C:\\Windows\\Fonts\\simsun.ttc'))
        font_name = 'simsun'
        font_bold = 'simsun'
    except:
        # æœ€åå¤‡é€‰ï¼šè‹±æ–‡å­—ä½“ï¼ˆä¸æ”¯æŒä¸­æ–‡ï¼‰
        font_name = 'Helvetica'
        font_bold = 'Helvetica-Bold'

# Linuxå­—ä½“è·¯å¾„
# /usr/share/fonts/truetype/
# å¸¸ç”¨: WenQuanYi Micro Hei (æ–‡æ³‰é©¿å¾®ç±³é»‘)

# Macå­—ä½“è·¯å¾„
# /System/Library/Fonts/
# /Library/Fonts/
```

#### ğŸ¯ æœ€ä½³å®è·µ

**1. æ¨¡å‹å¯¼å…¥ç®¡ç†**
```python
# âœ… åœ¨db/base.pyä¸­é›†ä¸­å¯¼å…¥æ‰€æœ‰æ¨¡å‹
from app.models.user import User
from app.models.customer import Customer
from app.models.material import Material
from app.models.order import Order, OrderItem
from app.models.production import ProductionOrder, ProductionOrderItem, ProductionReport
from app.models.payment import OrderPayment

__all__ = [
    "Base", "User", "Customer", "Material",
    "Order", "OrderItem", "ProductionOrder", "ProductionOrderItem",
    "ProductionReport", "OrderPayment"
]

# å…¶ä»–æ–‡ä»¶å¯¼å…¥
from app.db.base import *  # ä¸€æ¬¡æ€§å¯¼å…¥æ‰€æœ‰æ¨¡å‹
```

**2. å­—æ®µå‘½åè§„èŒƒæ–‡æ¡£åŒ–**
```python
# åœ¨é¡¹ç›®æ–‡æ¡£ä¸­æ˜ç¡®è§„èŒƒ
"""
å­—æ®µå‘½åè§„èŒƒï¼š

1. è”ç³»ä¿¡æ¯ï¼šcontact_å‰ç¼€
   - contact_person, contact_phone, contact_address

2. æ—¶é—´å­—æ®µï¼šæ˜ç¡®åç¼€
   - created_at, updated_at (æ—¶é—´æˆ³)
   - plan_start_date, plan_end_date (ä¸šåŠ¡æ—¥æœŸ)

3. å¤‡æ³¨å­—æ®µï¼šç»Ÿä¸€ä½¿ç”¨remark
   - remark: Mapped[Optional[str]]

4. ç¼–å·å­—æ®µï¼šç»Ÿä¸€_noåç¼€
   - order_no, production_no, payment_no

5. çŠ¶æ€å­—æ®µï¼šä½¿ç”¨æšä¸¾
   - status: Mapped[OrderStatus]
"""
```

**3. å¼€å‘ç¯å¢ƒç¼“å­˜ç®¡ç†**
```bash
# å¼€å‘å¯åŠ¨è„šæœ¬ (dev.sh)
#!/bin/bash

echo "Cleaning Python cache..."
find backend -type f -name "*.pyc" -delete
find backend -type d -name "__pycache__" -delete

echo "Starting backend server..."
cd backend
PYTHONDONTWRITEBYTECODE=1 poetry run uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

**4. PDFç”ŸæˆæœåŠ¡æµ‹è¯•**
```python
# tests/test_pdf_service.py
import pytest
from app.services.pdf_service import PrintService

@pytest.mark.asyncio
async def test_generate_order_pdf(db_session):
    """æµ‹è¯•è®¢å•PDFç”Ÿæˆ"""
    pdf_buffer = await PrintService.generate_order_pdf(db_session, 1)

    # éªŒè¯PDFç”Ÿæˆ
    assert pdf_buffer is not None
    assert len(pdf_buffer.getvalue()) > 0

    # éªŒè¯PDFæ ¼å¼
    pdf_bytes = pdf_buffer.getvalue()
    assert pdf_bytes.startswith(b'%PDF')  # PDFæ–‡ä»¶å¤´

    # éªŒè¯æ–‡ä»¶å¤§å°åˆç†ï¼ˆé¿å…ç©ºPDFï¼‰
    assert len(pdf_bytes) > 1000

@pytest.mark.asyncio
async def test_generate_pdf_invalid_id(db_session):
    """æµ‹è¯•æ— æ•ˆID"""
    with pytest.raises(ValueError, match="è®¢å•ä¸å­˜åœ¨"):
        await PrintService.generate_order_pdf(db_session, 99999)
```

**5. å‰ç«¯é”™è¯¯å¤„ç†**
```javascript
// å®Œå–„çš„PDFä¸‹è½½å‡½æ•°
async function handlePrintOrder(orderId) {
    try {
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        ElMessage.info('æ­£åœ¨ç”ŸæˆPDF...')

        const response = await downloadOrderPDF(orderId)

        // æ£€æŸ¥å“åº”ç±»å‹
        if (response.type === 'application/json') {
            // æœåŠ¡å™¨è¿”å›äº†JSONé”™è¯¯
            const text = await response.text()
            const error = JSON.parse(text)
            throw new Error(error.detail || 'ç”ŸæˆPDFå¤±è´¥')
        }

        // ç”Ÿæˆæ–‡ä»¶å
        const filename = `è®¢å•_${orderNo}_${new Date().getTime()}.pdf`

        // ä¸‹è½½æ–‡ä»¶
        downloadFile(response, filename)
        ElMessage.success('PDFä¸‹è½½æˆåŠŸ')

    } catch (error) {
        console.error('ä¸‹è½½PDFå¤±è´¥:', error)

        // å‹å¥½çš„é”™è¯¯æç¤º
        if (error.response?.status === 404) {
            ElMessage.error('è®¢å•ä¸å­˜åœ¨')
        } else if (error.response?.status === 500) {
            ElMessage.error('æœåŠ¡å™¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•')
        } else {
            ElMessage.error(error.message || 'ä¸‹è½½å¤±è´¥')
        }
    }
}
```

#### ğŸ”§ é¢„é˜²æªæ–½

**1. ä»£ç å®¡æŸ¥æ£€æŸ¥æ¸…å•**
```markdown
PDFåŠŸèƒ½å¼€å‘æ£€æŸ¥é¡¹ï¼š
- [ ] æ‰€æœ‰relationshipå¼•ç”¨çš„æ¨¡å‹éƒ½å·²å¯¼å…¥
- [ ] å­—æ®µåä¸æ•°æ®åº“æ¨¡å‹å®Œå…¨ä¸€è‡´
- [ ] ä¸­æ–‡å­—ä½“å·²æ­£ç¡®é…ç½®
- [ ] å¼‚å¸¸å¤„ç†å®Œæ•´ï¼ˆValueError, Exceptionï¼‰
- [ ] ç‹¬ç«‹æµ‹è¯•è„šæœ¬é€šè¿‡
- [ ] APIç«¯ç‚¹æµ‹è¯•é€šè¿‡
- [ ] å‰ç«¯ä¸‹è½½å¤„ç†æ­£ç¡®ï¼ˆresponseType: 'blob'ï¼‰
- [ ] æ–‡ä»¶ååŒ…å«ä¸šåŠ¡ä¿¡æ¯ï¼ˆè®¢å•å·ç­‰ï¼‰
```

**2. è‡ªåŠ¨åŒ–æµ‹è¯•**
```python
# åœ¨CI/CDä¸­æ·»åŠ PDFç”Ÿæˆæµ‹è¯•
pytest tests/test_pdf_service.py -v

# æ£€æŸ¥æ¨¡å‹å¯¼å…¥å®Œæ•´æ€§
python -c "
from app.services.pdf_service import PrintService
from app.models.order import Order
import inspect
print('âœ… All imports successful')
"
```

**3. ç›‘æ§å‘Šè­¦**
```python
# æ·»åŠ PDFç”Ÿæˆç›‘æ§
import logging
from functools import wraps

def monitor_pdf_generation(func):
    @wraps(func)
    async def wrapper(*args, **kwargs):
        try:
            result = await func(*args, **kwargs)
            logger.info(f"PDF generated successfully: {func.__name__}")
            return result
        except Exception as e:
            logger.error(f"PDF generation failed: {func.__name__}, error: {e}")
            # å‘é€å‘Šè­¦é€šçŸ¥
            # send_alert(f"PDFç”Ÿæˆå¤±è´¥: {func.__name__}")
            raise
    return wrapper

@monitor_pdf_generation
async def generate_order_pdf(db, order_id):
    ...
```

#### ğŸ“š ç›¸å…³æ–‡æ¡£

- [reportlabå®˜æ–¹æ–‡æ¡£](https://www.reportlab.com/docs/reportlab-userguide.pdf)
- [FastAPI StreamingResponseæ–‡æ¡£](https://fastapi.tiangolo.com/advanced/custom-response/#streamingresponse)
- [SQLAlchemyå…³ç³»é…ç½®æ–‡æ¡£](https://docs.sqlalchemy.org/en/20/orm/relationships.html)

#### âš ï¸ å¸¸è§é™·é˜±

```python
# é™·é˜±1: å¾ªç¯å¯¼å…¥
# âŒ é”™è¯¯
# order.py
from app.models.production import ProductionOrder

# production.py
from app.models.order import Order
# ä¼šå¯¼è‡´å¾ªç¯å¯¼å…¥

# âœ… æ­£ç¡®ï¼šä½¿ç”¨å­—ç¬¦ä¸²å¼•ç”¨
class Order(Base):
    production_orders: Mapped[List["ProductionOrder"]] = relationship(...)

# é™·é˜±2: å¿˜è®°await
# âŒ é”™è¯¯
pdf_buffer = PrintService.generate_order_pdf(db, order_id)  # è¿”å›åç¨‹å¯¹è±¡

# âœ… æ­£ç¡®
pdf_buffer = await PrintService.generate_order_pdf(db, order_id)

# é™·é˜±3: BytesIOæœªseek(0)
# âŒ é”™è¯¯
buffer = BytesIO()
doc.build(elements)
return buffer  # æŒ‡é’ˆåœ¨æœ«å°¾ï¼Œè¯»å–ä¸ºç©º

# âœ… æ­£ç¡®
buffer = BytesIO()
doc.build(elements)
buffer.seek(0)  # é‡ç½®åˆ°å¼€å¤´
return buffer
```

---

## äºŒã€å‰ç«¯å¼€å‘é—®é¢˜

### 2.1 è·¯ç”±é…ç½®ä¸å¯¼èˆªé—®é¢˜

#### ğŸ“‹ é—®é¢˜æè¿°

**ç°è±¡**:
- è®¿é—® `/reports` æ˜¾ç¤º404
- ç‚¹å‡»èœå•æ²¡æœ‰ååº”
- é¡µé¢åˆ·æ–°åä¸¢å¤±çŠ¶æ€

**å¸¸è§é”™è¯¯**:
```javascript
// âŒ è·¯ç”±æœªæ³¨å†Œ
const routes = [
  { path: '/dashboard', ... },
  { path: '/orders', ... }
  // å¿˜è®°æ·»åŠ  reports è·¯ç”±
]

// âŒ è·¯ç”±è·¯å¾„é”™è¯¯
{ path: 'report', ... }  // å°‘äº†s
{ path: '/reports', ... }  // çˆ¶è·¯ç”±å·²æœ‰/ï¼Œè¿™é‡Œä¸éœ€è¦
```

#### ğŸ” æ ¹æœ¬åŸå› 

**Vue Routeré…ç½®é—®é¢˜**:
1. è·¯ç”±å®šä¹‰ä¸å®é™…è·¯å¾„ä¸åŒ¹é…
2. åµŒå¥—è·¯ç”±çš„è·¯å¾„æ‹¼æ¥é”™è¯¯
3. è·¯ç”±å®ˆå«é€»è¾‘é—®é¢˜
4. æ‡’åŠ è½½ç»„ä»¶è·¯å¾„é”™è¯¯

#### âœ… è§£å†³æ–¹æ¡ˆ

**æ­£ç¡®çš„è·¯ç”±é…ç½®**:
```javascript
// router/index.js
const routes = [
  {
    path: '/',
    component: () => import('@/views/Layout.vue'),
    redirect: '/dashboard',
    meta: { requiresAuth: true },
    children: [  // åµŒå¥—è·¯ç”±
      {
        path: 'dashboard',  // âœ… ä¸è¦åŠ  /
        name: 'Dashboard',
        component: () => import('@/views/Dashboard.vue'),
        meta: { title: 'ä»ªè¡¨ç›˜' }
      },
      {
        path: 'reports',  // âœ… å®Œæ•´è·¯å¾„æ˜¯ /reports
        name: 'Reports',
        component: () => import('@/views/Reports.vue'),
        meta: { title: 'è´¢åŠ¡æŠ¥è¡¨' }
      }
    ]
  }
]
```

**è·¯ç”±å®ˆå«**:
```javascript
router.beforeEach(async (to, from, next) => {
  const userStore = useUserStore()
  const requiresAuth = to.matched.some(
    record => record.meta.requiresAuth !== false
  )

  if (requiresAuth && !userStore.token) {
    next('/login')  // æœªç™»å½•è·³è½¬
  } else {
    next()  // æ”¾è¡Œ
  }
})
```

#### ğŸ’¡ å­¦ä¹ è¦ç‚¹

**Vue Routeræ ¸å¿ƒæ¦‚å¿µ**:
```javascript
// 1. è·¯ç”±å®šä¹‰
{
  path: '/users/:id',     // åŠ¨æ€è·¯å¾„å‚æ•°
  name: 'UserDetail',     // å‘½åè·¯ç”±
  component: UserDetail,  // ç»„ä»¶
  meta: { auth: true }    // å…ƒä¿¡æ¯
}

// 2. ç¼–ç¨‹å¼å¯¼èˆª
router.push('/users')           // å­—ç¬¦ä¸²
router.push({ name: 'User' })   // å‘½åè·¯ç”±
router.push({ path: '/users', query: { id: 1 } })  // å¸¦æŸ¥è¯¢å‚æ•°

// 3. å£°æ˜å¼å¯¼èˆª
<router-link to="/users">Users</router-link>
<router-link :to="{ name: 'User', params: { id: 1 } }">
```

**æœ€ä½³å®è·µ**:
1. âœ… ä½¿ç”¨å‘½åè·¯ç”±ï¼Œé¿å…ç¡¬ç¼–ç è·¯å¾„
2. âœ… è·¯ç”±æ‡’åŠ è½½ï¼Œä¼˜åŒ–é¦–å±åŠ è½½
3. âœ… ç»Ÿä¸€ç®¡ç†è·¯ç”±å…ƒä¿¡æ¯
4. âœ… è·¯ç”±å®ˆå«å¤„ç†æƒé™æ§åˆ¶

---

### 2.2 çŠ¶æ€ç®¡ç†ä¸æ•°æ®æŒä¹…åŒ–

#### ğŸ“‹ é—®é¢˜æè¿°

**ç°è±¡**:
- åˆ·æ–°é¡µé¢åç”¨æˆ·ä¿¡æ¯ä¸¢å¤±
- ç™»å½•çŠ¶æ€æ— æ³•ä¿æŒ
- Tokenå¤±æ•ˆåæœªåŠæ—¶æ¸…ç†

**é”™è¯¯ä»£ç **:
```javascript
// âŒ åªå­˜åœ¨å†…å­˜ä¸­
const userStore = defineStore('user', {
  state: () => ({
    token: null,  // åˆ·æ–°é¡µé¢åä¸¢å¤±
    userInfo: null
  })
})
```

#### âœ… è§£å†³æ–¹æ¡ˆ

**Pinia + LocalStorage**:
```javascript
// stores/user.js
import { defineStore } from 'pinia'

export const useUserStore = defineStore('user', {
  state: () => ({
    token: localStorage.getItem('token') || null,  // âœ… ä»localStorageæ¢å¤
    userInfo: JSON.parse(localStorage.getItem('userInfo') || 'null')
  }),

  actions: {
    setToken(token) {
      this.token = token
      localStorage.setItem('token', token)  // âœ… åŒæ­¥åˆ°localStorage
    },

    setUserInfo(info) {
      this.userInfo = info
      localStorage.setItem('userInfo', JSON.stringify(info))
    },

    logout() {
      this.token = null
      this.userInfo = null
      localStorage.removeItem('token')  // âœ… æ¸…ç†
      localStorage.removeItem('userInfo')
    },

    async validateToken() {
      if (!this.token) return false

      try {
        // éªŒè¯tokenæœ‰æ•ˆæ€§
        await api.get('/auth/validate')
        return true
      } catch (error) {
        this.logout()  // Tokenæ— æ•ˆï¼Œæ¸…ç†çŠ¶æ€
        return false
      }
    }
  }
})
```

#### ğŸ’¡ å­¦ä¹ è¦ç‚¹

**çŠ¶æ€æŒä¹…åŒ–æ–¹æ¡ˆ**:
```javascript
// 1. localStorageï¼ˆæ°¸ä¹…å­˜å‚¨ï¼‰
localStorage.setItem('key', 'value')
localStorage.getItem('key')
localStorage.removeItem('key')

// 2. sessionStorageï¼ˆä¼šè¯å­˜å‚¨ï¼‰
sessionStorage.setItem('key', 'value')  // å…³é—­æ ‡ç­¾é¡µåæ¸…é™¤

// 3. Cookieï¼ˆå¯è®¾ç½®è¿‡æœŸæ—¶é—´ï¼‰
document.cookie = "token=xxx; expires=..."

// 4. IndexedDBï¼ˆå¤§é‡æ•°æ®ï¼‰
// é€‚åˆå­˜å‚¨å¤æ‚æ•°æ®ç»“æ„
```

**å®‰å…¨è€ƒè™‘**:
```javascript
// âŒ ä¸è¦å­˜å‚¨æ•æ„Ÿä¿¡æ¯æ˜æ–‡
localStorage.setItem('password', 'admin123')

// âœ… åªå­˜å‚¨tokenï¼ŒæœåŠ¡ç«¯éªŒè¯
localStorage.setItem('token', 'eyJhbGc...')

// âœ… Tokenæ·»åŠ è¿‡æœŸæ—¶é—´
const tokenData = {
  token: 'xxx',
  expiresAt: Date.now() + 7200000  // 2å°æ—¶
}
localStorage.setItem('auth', JSON.stringify(tokenData))
```

---

### 2.3 Excelæ–‡ä»¶ä¸‹è½½å“åº”æ‹¦æˆªå™¨å†²çª

#### ğŸ“‹ é—®é¢˜æè¿°

**ç°è±¡**:
```javascript
// å‰ç«¯æ§åˆ¶å°é”™è¯¯
å¯¼å‡ºå¤±è´¥: Cannot read properties of undefined (reading 'type')

// å‘ç”Ÿåœ¨excel.jsæ–‡ä»¶ä¸­
if (response.data.type === 'application/json') {
    // âŒ response.dataæ˜¯undefined
}
```

**å…·ä½“è¡¨ç°**:
- âœ… æ™®é€šAPIè¯·æ±‚ï¼ˆå¦‚è·å–åˆ—è¡¨ï¼‰æ­£å¸¸å·¥ä½œ
- âŒ Excelå¯¼å‡ºåŠŸèƒ½æŠ¥é”™ï¼Œæ— æ³•ä¸‹è½½æ–‡ä»¶
- âŒ ä¸‹è½½æ¨¡æ¿åŠŸèƒ½åŒæ ·å¤±è´¥
- æµè§ˆå™¨Networkæ˜¾ç¤ºè¯·æ±‚æˆåŠŸï¼ˆ200ï¼‰ï¼Œä½†å‰ç«¯æ— æ³•å¤„ç†å“åº”

#### ğŸ” æ ¹æœ¬åŸå› 

**Axioså“åº”æ‹¦æˆªå™¨å¯¼è‡´çš„ç»“æ„å˜åŒ–**:

```javascript
// request.js ä¸­çš„å“åº”æ‹¦æˆªå™¨
request.interceptors.response.use(
  (response) => {
    const res = response.data  // âœ… å¯¹JSONå“åº”æœ‰æ•ˆ

    if (res.code && res.code !== 200) {
      ElMessage.error(res.msg || 'è¯·æ±‚å¤±è´¥')
      return Promise.reject(new Error(res.msg || 'è¯·æ±‚å¤±è´¥'))
    }

    return res  // âŒ é—®é¢˜ï¼šè¿”å› response.data è€Œä¸æ˜¯å®Œæ•´çš„ response
  },
  (error) => { ... }
)
```

**ä¸ºä»€ä¹ˆä¼šå‡ºé”™**:
```javascript
// 1. æ­£å¸¸JSONå“åº”
{
  headers: { ... },
  data: { code: 200, msg: "success", data: [...] }  // âœ… JSONå¯¹è±¡
}
// æ‹¦æˆªå™¨è¿”å› response.data = { code: 200, msg: "success", data: [...] }

// 2. Blobå“åº”ï¼ˆExcelæ–‡ä»¶ï¼‰
{
  headers: {
    'content-disposition': 'attachment; filename*=UTF-8\'\'...',
    'content-type': 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
  },
  data: Blob { ... }  // âœ… Blobå¯¹è±¡
}
// æ‹¦æˆªå™¨è¿”å› response.data = Blobå¯¹è±¡
// âŒ ä½†æ˜¯ excel.js éœ€è¦è®¿é—® response.headersï¼

// 3. excel.js ä¸­çš„å¤„ç†é€»è¾‘
const disposition = response.headers['content-disposition']  // âŒ undefined
// å› ä¸ºæ‹¦æˆªå™¨åªè¿”å›äº† response.data (Blob)ï¼Œæ²¡æœ‰ headers
```

**å…³é”®é—®é¢˜**:
1. **å“åº”æ‹¦æˆªå™¨æ”¹å˜äº†è¿”å›ç»“æ„**ï¼šåªè¿”å›`response.data`ï¼Œä¸¢å¤±äº†`response.headers`
2. **Excelä¸‹è½½éœ€è¦headers**ï¼šéœ€è¦ä»`Content-Disposition`å¤´ä¸­æå–æ–‡ä»¶å
3. **æ— æ³•è®¿é—®å®Œæ•´å“åº”å¯¹è±¡**ï¼šå¯¼è‡´`response.headers`å˜æˆ`undefined`
4. **responseType: 'blob'ä¸å½±å“æ‹¦æˆªå™¨**ï¼šæ‹¦æˆªå™¨ä»ç„¶æ‰§è¡Œç›¸åŒçš„é€»è¾‘

#### âœ… è§£å†³æ–¹æ¡ˆ

**æ–¹æ¡ˆ1: åˆ›å»ºä¸“ç”¨æ–‡ä»¶ä¸‹è½½axioså®ä¾‹ï¼ˆæ¨èï¼‰**

```javascript
// frontend/src/api/excel.js
import request from './request'
import axios from 'axios'

// âœ… åˆ›å»ºä¸“é—¨ç”¨äºæ–‡ä»¶ä¸‹è½½çš„axioså®ä¾‹
const fileRequest = axios.create({
  baseURL: 'http://localhost:8000/api/v1',
  timeout: 60000  // æ–‡ä»¶ä¸‹è½½å¯èƒ½éœ€è¦æ›´é•¿æ—¶é—´
})

// âœ… åªæ·»åŠ è¯·æ±‚æ‹¦æˆªå™¨ï¼ˆæ·»åŠ tokenï¼‰
fileRequest.interceptors.request.use(
  (config) => {
    const token = localStorage.getItem('access_token')
    if (token) {
      config.headers.Authorization = `Bearer ${token}`
    }
    return config
  },
  (error) => Promise.reject(error)
)

// âŒ ä¸æ·»åŠ å“åº”æ‹¦æˆªå™¨ï¼ä¿ç•™å®Œæ•´çš„responseå¯¹è±¡

/**
 * ä¸‹è½½Excelæ¨¡æ¿
 */
export async function downloadTemplate(url, defaultFilename = 'template.xlsx') {
  try {
    const response = await fileRequest.get(url, { responseType: 'blob' })

    // âœ… ç°åœ¨å¯ä»¥è®¿é—®å®Œæ•´çš„responseå¯¹è±¡
    const disposition = response.headers['content-disposition']
    const filename = getFilenameFromDisposition(disposition) || defaultFilename

    downloadFile(response.data, filename)
    return { success: true }
  } catch (error) {
    console.error('ä¸‹è½½æ¨¡æ¿å¤±è´¥:', error)
    throw error
  }
}

/**
 * å¯¼å‡ºExcelæ•°æ®
 */
export async function exportExcel(url, params = {}, defaultFilename = 'export.xlsx') {
  try {
    const response = await fileRequest.get(url, {
      params,
      responseType: 'blob'
    })

    // âœ… æ£€æŸ¥æ˜¯å¦æ˜¯JSONé”™è¯¯å“åº”
    if (response.data.type === 'application/json') {
      const text = await response.data.text()
      const error = JSON.parse(text)
      throw new Error(error.detail || 'å¯¼å‡ºå¤±è´¥')
    }

    const disposition = response.headers['content-disposition']
    const filename = getFilenameFromDisposition(disposition) || defaultFilename

    downloadFile(response.data, filename)
    return { success: true, filename }
  } catch (error) {
    console.error('å¯¼å‡ºExcelå¤±è´¥:', error)
    throw error
  }
}
```

**æ–¹æ¡ˆ2: ä¿®æ”¹å“åº”æ‹¦æˆªå™¨æ¡ä»¶åˆ¤æ–­ï¼ˆä¸æ¨èï¼‰**

```javascript
// request.js
request.interceptors.response.use(
  (response) => {
    // âœ… æ£€æŸ¥å“åº”ç±»å‹
    if (response.config.responseType === 'blob') {
      return response  // ä¿ç•™å®Œæ•´å“åº”å¯¹è±¡
    }

    // å¤„ç†JSONå“åº”
    const res = response.data
    if (res.code && res.code !== 200) {
      ElMessage.error(res.msg || 'è¯·æ±‚å¤±è´¥')
      return Promise.reject(new Error(res.msg || 'è¯·æ±‚å¤±è´¥'))
    }

    return res
  },
  (error) => { ... }
)

// âŒ ç¼ºç‚¹ï¼š
// 1. å¢åŠ äº†æ‹¦æˆªå™¨çš„å¤æ‚åº¦
// 2. éœ€è¦è®°å¾—æ‰€æœ‰æ–‡ä»¶ä¸‹è½½éƒ½è¦è®¾ç½® responseType: 'blob'
// 3. å¯èƒ½å½±å“å…¶ä»–ç±»å‹çš„å“åº”å¤„ç†
```

**æ–¹æ¡ˆ3: ä½¿ç”¨åŸå§‹axioså®ä¾‹ï¼ˆä¸æ¨èï¼‰**

```javascript
// âŒ ä¸æ¨èï¼šæ¯æ¬¡éƒ½è¦æ‰‹åŠ¨æ·»åŠ token
import axios from 'axios'

export async function downloadTemplate(url) {
  const token = localStorage.getItem('access_token')

  const response = await axios.get(`http://localhost:8000/api/v1${url}`, {
    headers: {
      'Authorization': `Bearer ${token}`
    },
    responseType: 'blob'
  })

  // å¤„ç†å“åº”...
}
```

#### ğŸ’¡ å­¦ä¹ è¦ç‚¹

**1. Axiosæ‹¦æˆªå™¨çš„ä½œç”¨åŸŸ**

```javascript
// è¯·æ±‚æ‹¦æˆªå™¨ï¼šä¿®æ”¹è¯·æ±‚é…ç½®
request.interceptors.request.use(
  (config) => {
    // ä¿®æ”¹headersã€paramsç­‰
    config.headers.Authorization = `Bearer ${token}`
    return config  // âœ… å¿…é¡»è¿”å›config
  }
)

// å“åº”æ‹¦æˆªå™¨ï¼šå¤„ç†å“åº”æ•°æ®
request.interceptors.response.use(
  (response) => {
    // âš ï¸ è¿”å›ä»€ä¹ˆï¼Œè°ƒç”¨æ–¹å°±æ”¶åˆ°ä»€ä¹ˆ
    return response.data  // åªè¿”å›dataéƒ¨åˆ†
    // vs
    return response       // è¿”å›å®Œæ•´å“åº”å¯¹è±¡
  }
)
```

**2. ä¸åŒå“åº”ç±»å‹çš„å¤„ç†**

```javascript
// JSONå“åº”
{
  data: { code: 200, msg: "success", data: [...] },
  headers: { 'content-type': 'application/json' },
  status: 200
}

// Blobå“åº”ï¼ˆæ–‡ä»¶ï¼‰
{
  data: Blob { size: 12345, type: 'application/vnd.ms-excel' },
  headers: {
    'content-type': 'application/vnd.ms-excel',
    'content-disposition': 'attachment; filename*=UTF-8\'\'%E5%AE%A2%E6%88%B7%E6%95%B0%E6%8D%AE.xlsx'
  },
  status: 200
}

// å…³é”®åŒºåˆ«ï¼š
// - JSONå“åº”ä¸»è¦ä½¿ç”¨ response.data
// - Blobå“åº”éœ€è¦åŒæ—¶ä½¿ç”¨ response.data å’Œ response.headers
```

**3. Content-Dispositionå¤´çš„è§£æ**

```javascript
// æœåŠ¡ç«¯è¿”å›çš„å“åº”å¤´æ ¼å¼
'Content-Disposition': 'attachment; filename*=UTF-8\'\'%E5%AE%A2%E6%88%B7%E6%95%B0%E6%8D%AE.xlsx'

// è§£æå‡½æ•°
export function getFilenameFromDisposition(disposition) {
  if (!disposition) return 'download.xlsx'

  // âœ… åŒ¹é… filename*=UTF-8''xxx æ ¼å¼ï¼ˆæ”¯æŒä¸­æ–‡ï¼‰
  const filenameRegex = /filename\*=UTF-8''(.+)/i
  const matches = filenameRegex.exec(disposition)

  if (matches && matches[1]) {
    return decodeURIComponent(matches[1])  // URLè§£ç 
    // %E5%AE%A2%E6%88%B7%E6%95%B0%E6%8D%AE.xlsx â†’ å®¢æˆ·æ•°æ®.xlsx
  }

  // å¤‡é€‰ï¼šåŒ¹é… filename="xxx" æ ¼å¼
  const filenameRegex2 = /filename="(.+)"/i
  const matches2 = filenameRegex2.exec(disposition)

  if (matches2 && matches2[1]) {
    return matches2[1]
  }

  return 'download.xlsx'
}
```

**4. Blobæ–‡ä»¶ä¸‹è½½çš„å®Œæ•´æµç¨‹**

```javascript
// æ­¥éª¤1: è¯·æ±‚Blobæ•°æ®
const response = await axios.get(url, {
  responseType: 'blob'  // âœ… å…³é”®ï¼šå‘Šè¯‰axiosè¿”å›Blobå¯¹è±¡
})

// æ­¥éª¤2: åˆ›å»ºä¸´æ—¶URL
const blob = response.data
const blobUrl = window.URL.createObjectURL(blob)
// blob:http://localhost:5173/12345678-1234-1234-1234-123456789abc

// æ­¥éª¤3: åˆ›å»º<a>æ ‡ç­¾å¹¶è§¦å‘ä¸‹è½½
const link = document.createElement('a')
link.href = blobUrl
link.setAttribute('download', filename)  // æŒ‡å®šæ–‡ä»¶å
document.body.appendChild(link)
link.click()  // è§¦å‘ä¸‹è½½

// æ­¥éª¤4: æ¸…ç†èµ„æº
link.remove()
window.URL.revokeObjectURL(blobUrl)  // âœ… é‡Šæ”¾å†…å­˜
```

**5. å¤šaxioså®ä¾‹çš„ä½¿ç”¨åœºæ™¯**

```javascript
// åœºæ™¯1: æ™®é€šAPIè¯·æ±‚ï¼ˆéœ€è¦ç»Ÿä¸€é”™è¯¯å¤„ç†ï¼‰
const apiRequest = axios.create({
  baseURL: '/api/v1',
  timeout: 15000
})
apiRequest.interceptors.response.use(
  (res) => res.data,  // ç®€åŒ–å“åº”ç»“æ„
  (err) => handleError(err)
)

// åœºæ™¯2: æ–‡ä»¶ä¸Šä¼ /ä¸‹è½½ï¼ˆéœ€è¦å®Œæ•´å“åº”å¯¹è±¡ï¼‰
const fileRequest = axios.create({
  baseURL: '/api/v1',
  timeout: 60000
})
// ä¸æ·»åŠ å“åº”æ‹¦æˆªå™¨

// åœºæ™¯3: ç¬¬ä¸‰æ–¹APIï¼ˆä¸åŒçš„baseURLå’Œè®¤è¯æ–¹å¼ï¼‰
const externalRequest = axios.create({
  baseURL: 'https://api.external.com',
  headers: { 'X-API-Key': 'xxx' }
})

// ä½¿ç”¨æ–¹å¼ï¼š
import { apiRequest, fileRequest } from '@/api/request'

// æ™®é€šè¯·æ±‚
const orders = await apiRequest.get('/orders')

// æ–‡ä»¶ä¸‹è½½
const response = await fileRequest.get('/export', { responseType: 'blob' })
```

#### ğŸ¯ æœ€ä½³å®è·µ

**1. åˆ†ç¦»æ–‡ä»¶è¯·æ±‚å’Œæ•°æ®è¯·æ±‚**

```javascript
// âœ… æ¨èçš„é¡¹ç›®ç»“æ„
src/api/
â”œâ”€â”€ request.js          # æ™®é€šAPIè¯·æ±‚ï¼ˆå¸¦æ‹¦æˆªå™¨ï¼‰
â”œâ”€â”€ fileRequest.js      # æ–‡ä»¶è¯·æ±‚ï¼ˆæ— å“åº”æ‹¦æˆªå™¨ï¼‰
â”œâ”€â”€ excel.js            # Excelå¯¼å…¥å¯¼å‡ºï¼ˆä½¿ç”¨fileRequestï¼‰
â”œâ”€â”€ order.js            # è®¢å•APIï¼ˆä½¿ç”¨requestï¼‰
â””â”€â”€ customer.js         # å®¢æˆ·APIï¼ˆä½¿ç”¨requestï¼‰
```

**2. ç»Ÿä¸€çš„é”™è¯¯å¤„ç†**

```javascript
// æ–‡ä»¶ä¸‹è½½é”™è¯¯å¤„ç†
export async function downloadTemplate(url, defaultFilename) {
  try {
    const response = await fileRequest.get(url, { responseType: 'blob' })

    // âœ… æ£€æŸ¥æ˜¯å¦æ˜¯JSONé”™è¯¯å“åº”
    if (response.data.type === 'application/json') {
      const text = await response.data.text()
      const error = JSON.parse(text)
      throw new Error(error.detail || 'ä¸‹è½½å¤±è´¥')
    }

    // æ­£å¸¸å¤„ç†Blob
    downloadFile(response.data, filename)
    return { success: true }

  } catch (error) {
    // âœ… ç»Ÿä¸€çš„é”™è¯¯å¤„ç†
    if (error.response) {
      // HTTPé”™è¯¯
      const status = error.response.status
      if (status === 401) {
        ElMessage.error('æœªæˆæƒï¼Œè¯·é‡æ–°ç™»å½•')
        router.push('/login')
      } else if (status === 404) {
        ElMessage.error('èµ„æºä¸å­˜åœ¨')
      } else {
        ElMessage.error('ä¸‹è½½å¤±è´¥ï¼š' + error.message)
      }
    } else {
      // ç½‘ç»œé”™è¯¯
      ElMessage.error('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥')
    }
    throw error
  }
}
```

**3. æ–‡ä»¶åå¤„ç†çš„å…¼å®¹æ€§**

```javascript
// âœ… å…¼å®¹ä¸åŒæµè§ˆå™¨çš„æ–‡ä»¶åå¤„ç†
export function getFilenameFromDisposition(disposition) {
  if (!disposition) return 'download.xlsx'

  // ä¼˜å…ˆçº§1: RFC 5987æ ¼å¼ï¼ˆæ”¯æŒUTF-8ç¼–ç ï¼‰
  // Content-Disposition: attachment; filename*=UTF-8''%E6%96%87%E4%BB%B6.xlsx
  const utf8Regex = /filename\*=UTF-8''(.+)/i
  const utf8Match = utf8Regex.exec(disposition)
  if (utf8Match && utf8Match[1]) {
    try {
      return decodeURIComponent(utf8Match[1])
    } catch (e) {
      console.warn('Failed to decode UTF-8 filename:', e)
    }
  }

  // ä¼˜å…ˆçº§2: æ ‡å‡†æ ¼å¼ï¼ˆå¯èƒ½ä¸æ”¯æŒä¸­æ–‡ï¼‰
  // Content-Disposition: attachment; filename="file.xlsx"
  const standardRegex = /filename="(.+)"/i
  const standardMatch = standardRegex.exec(disposition)
  if (standardMatch && standardMatch[1]) {
    return standardMatch[1]
  }

  // ä¼˜å…ˆçº§3: ç®€å•æ ¼å¼ï¼ˆæ— å¼•å·ï¼‰
  // Content-Disposition: attachment; filename=file.xlsx
  const simpleRegex = /filename=([^;]+)/i
  const simpleMatch = simpleRegex.exec(disposition)
  if (simpleMatch && simpleMatch[1]) {
    return simpleMatch[1].trim()
  }

  return 'download.xlsx'
}
```

**4. å†…å­˜ç®¡ç†**

```javascript
// âœ… æ­£ç¡®çš„Blob URLç®¡ç†
export function downloadFile(blob, filename) {
  const url = window.URL.createObjectURL(blob)

  try {
    const link = document.createElement('a')
    link.href = url
    link.setAttribute('download', filename)
    document.body.appendChild(link)
    link.click()
    link.remove()
  } finally {
    // âœ… ç¡®ä¿URLè¢«é‡Šæ”¾ï¼ˆå³ä½¿å‡ºé”™ï¼‰
    window.URL.revokeObjectURL(url)
  }
}

// âŒ å¸¸è§é”™è¯¯ï¼šå¿˜è®°é‡Šæ”¾URL
export function downloadFileBad(blob, filename) {
  const url = window.URL.createObjectURL(blob)
  const link = document.createElement('a')
  link.href = url
  link.click()
  // âŒ URLæœªé‡Šæ”¾ï¼Œå†…å­˜æ³„æ¼
}
```

#### ğŸ”§ è°ƒè¯•æŠ€å·§

**1. æ£€æŸ¥å“åº”ç»“æ„**

```javascript
// åœ¨æ‹¦æˆªå™¨ä¸­æ‰“å°å®Œæ•´å“åº”
request.interceptors.response.use(
  (response) => {
    console.log('Response:', {
      data: response.data,
      headers: response.headers,
      status: response.status,
      config: {
        url: response.config.url,
        responseType: response.config.responseType
      }
    })
    return response.data
  }
)
```

**2. éªŒè¯Blobå†…å®¹**

```javascript
// æ£€æŸ¥Blobæ˜¯å¦æœ‰æ•ˆ
const blob = response.data
console.log('Blob info:', {
  size: blob.size,
  type: blob.type
})

// å¦‚æœsizeä¸º0æˆ–typeä¸å¯¹ï¼Œè¯´æ˜ä¸‹è½½å¤±è´¥
if (blob.size === 0) {
  throw new Error('ä¸‹è½½çš„æ–‡ä»¶ä¸ºç©º')
}

// æ£€æŸ¥æ˜¯å¦æ˜¯JSONé”™è¯¯ï¼ˆæœåŠ¡ç«¯è¿”å›é”™è¯¯ï¼‰
if (blob.type === 'application/json') {
  const text = await blob.text()
  const error = JSON.parse(text)
  throw new Error(error.detail)
}
```

**3. æµè§ˆå™¨Networké¢æ¿åˆ†æ**

```
Network Tabæ£€æŸ¥é¡¹ï¼š
1. âœ… Status: 200 OKï¼ˆè¯·æ±‚æˆåŠŸï¼‰
2. âœ… Response Type: blobï¼ˆå“åº”ç±»å‹æ­£ç¡®ï¼‰
3. âœ… Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet
4. âœ… Content-Disposition: attachment; filename*=...ï¼ˆåŒ…å«æ–‡ä»¶åï¼‰
5. âœ… Response Size: > 0ï¼ˆæ–‡ä»¶å¤§å°æ­£å¸¸ï¼‰
6. âœ… Authorization: Bearer xxxï¼ˆtokenå·²å‘é€ï¼‰

å¸¸è§é—®é¢˜ï¼š
- Status 401 â†’ tokenè¿‡æœŸæˆ–ç¼ºå¤±
- Status 500 â†’ æœåŠ¡ç«¯é”™è¯¯ï¼ŒæŸ¥çœ‹response body
- Content-Type: application/json â†’ æœåŠ¡ç«¯è¿”å›é”™è¯¯ä¿¡æ¯è€Œéæ–‡ä»¶
- Size: 0 â†’ ç”Ÿæˆæ–‡ä»¶å¤±è´¥
```

#### âš ï¸ å¸¸è§é™·é˜±

```javascript
// é™·é˜±1: ä½¿ç”¨å¸¦å“åº”æ‹¦æˆªå™¨çš„å®ä¾‹ä¸‹è½½æ–‡ä»¶
// âŒ é”™è¯¯
const response = await request.get(url, { responseType: 'blob' })
console.log(response.headers)  // undefinedï¼ˆæ‹¦æˆªå™¨åªè¿”å›äº†dataï¼‰

// âœ… æ­£ç¡®
const response = await fileRequest.get(url, { responseType: 'blob' })
console.log(response.headers)  // { 'content-disposition': '...' }

// é™·é˜±2: å¿˜è®°è®¾ç½®responseType
// âŒ é”™è¯¯
const response = await fileRequest.get(url)  // é»˜è®¤æ˜¯JSON
// response.data æ˜¯å­—ç¬¦ä¸²ï¼Œä¸æ˜¯Blob

// âœ… æ­£ç¡®
const response = await fileRequest.get(url, { responseType: 'blob' })

// é™·é˜±3: å¤šæ¬¡åˆ›å»ºBlob URLä¸é‡Šæ”¾
// âŒ é”™è¯¯
for (let i = 0; i < 100; i++) {
  const url = window.URL.createObjectURL(blob)
  // å†…å­˜æ³„æ¼100æ¬¡
}

// âœ… æ­£ç¡®
const url = window.URL.createObjectURL(blob)
try {
  // ä½¿ç”¨URL
} finally {
  window.URL.revokeObjectURL(url)
}

// é™·é˜±4: åŒæ­¥æ–¹å¼å¤„ç†Blob.text()
// âŒ é”™è¯¯
const text = blob.text()  // è¿”å›Promise
const json = JSON.parse(text)  // é”™è¯¯ï¼štextæ˜¯Promise

// âœ… æ­£ç¡®
const text = await blob.text()
const json = JSON.parse(text)
```

#### ğŸ“š ç›¸å…³çŸ¥è¯†ç‚¹

**1. HTTPå“åº”ç±»å‹**
- `application/json` - JSONæ•°æ®
- `application/vnd.openxmlformats-officedocument.spreadsheetml.sheet` - Excelæ–‡ä»¶(.xlsx)
- `application/vnd.ms-excel` - Excelæ–‡ä»¶(.xls)
- `application/pdf` - PDFæ–‡ä»¶
- `text/csv` - CSVæ–‡ä»¶

**2. Content-Dispositionæ ‡å‡†**
- RFC 2183: Content-DispositionåŸå§‹è§„èŒƒ
- RFC 5987: æ”¯æŒéASCIIå­—ç¬¦çš„å‚æ•°ç¼–ç 
- RFC 6266: HTTPä¸­Content-Dispositionçš„ä½¿ç”¨

**3. Blob API**
```javascript
// Blobæ„é€ 
const blob = new Blob([data], { type: 'text/plain' })

// Blobå±æ€§
blob.size      // å¤§å°ï¼ˆå­—èŠ‚ï¼‰
blob.type      // MIMEç±»å‹

// Blobæ–¹æ³•
blob.text()    // è¿”å›Promise<string>
blob.arrayBuffer()  // è¿”å›Promise<ArrayBuffer>
blob.slice(start, end, type)  // åˆ‡ç‰‡
```

#### ğŸ”— ç›¸å…³æ–‡æ¡£

- [Axiosæ‹¦æˆªå™¨æ–‡æ¡£](https://axios-http.com/docs/interceptors)
- [MDN: Blob](https://developer.mozilla.org/en-US/docs/Web/API/Blob)
- [MDN: URL.createObjectURL](https://developer.mozilla.org/en-US/docs/Web/API/URL/createObjectURL)
- [RFC 6266: Content-Disposition](https://datatracker.ietf.org/doc/html/rfc6266)

---

## ä¸‰ã€æ•°æ®åº“è®¾è®¡é—®é¢˜

### 3.1 å¤–é”®çº¦æŸä¸æ•°æ®å®Œæ•´æ€§

#### ğŸ“‹ é—®é¢˜æè¿°

**ç°è±¡**:
- åˆ é™¤è®¢å•æ—¶ï¼Œå…³è”çš„ç”Ÿäº§å·¥å•ä»ç„¶å­˜åœ¨
- è®¢å•æ˜ç»†ä¸­çš„material_idæŒ‡å‘ä¸å­˜åœ¨çš„ç‰©æ–™
- æ•°æ®ä¸ä¸€è‡´å¯¼è‡´æŸ¥è¯¢é”™è¯¯

#### âœ… è§£å†³æ–¹æ¡ˆ

**æ­£ç¡®çš„å¤–é”®è®¾è®¡**:
```sql
CREATE TABLE erp_production_orders (
    id INT PRIMARY KEY AUTO_INCREMENT,
    order_id INT NOT NULL,

    -- å¤–é”®çº¦æŸ
    FOREIGN KEY (order_id)
    REFERENCES erp_orders(id)
    ON DELETE CASCADE      -- åˆ é™¤è®¢å•æ—¶çº§è”åˆ é™¤å·¥å•
    ON UPDATE CASCADE,     -- æ›´æ–°è®¢å•IDæ—¶çº§è”æ›´æ–°

    INDEX idx_order_id (order_id)
);
```

**SQLAlchemyå®šä¹‰**:
```python
class ProductionOrder(Base):
    __tablename__ = "erp_production_orders"

    id: Mapped[int] = mapped_column(primary_key=True)
    order_id: Mapped[int] = mapped_column(
        ForeignKey("erp_orders.id", ondelete="CASCADE"),
        index=True
    )

    # å®šä¹‰å…³ç³»
    order: Mapped["Order"] = relationship(
        back_populates="production_orders"
    )
```

#### ğŸ’¡ å­¦ä¹ è¦ç‚¹

**å¤–é”®çº§è”æ“ä½œ**:
- `CASCADE`: ä¸»è¡¨åˆ é™¤/æ›´æ–°æ—¶ï¼Œä»è¡¨è‡ªåŠ¨åˆ é™¤/æ›´æ–°
- `SET NULL`: ä¸»è¡¨åˆ é™¤æ—¶ï¼Œä»è¡¨å¤–é”®è®¾ä¸ºNULL
- `RESTRICT`: ç¦æ­¢åˆ é™¤ï¼ˆå¦‚æœæœ‰å…³è”æ•°æ®ï¼‰
- `NO ACTION`: ä¸åšå¤„ç†ï¼ˆå¯èƒ½å¯¼è‡´é”™è¯¯ï¼‰

**æ•°æ®å®Œæ•´æ€§ä¿è¯**:
1. âœ… ä½¿ç”¨å¤–é”®çº¦æŸ
2. âœ… æ·»åŠ å”¯ä¸€çº¦æŸï¼ˆå¦‚è®¢å•å·ï¼‰
3. âœ… ä½¿ç”¨NOT NULLçº¦æŸå¿…å¡«å­—æ®µ
4. âœ… æ·»åŠ CHECKçº¦æŸéªŒè¯æ•°æ®èŒƒå›´

---

## å››ã€ç³»ç»Ÿæ¶æ„é—®é¢˜

### 4.1 å‰åç«¯åˆ†ç¦»çš„è·¨åŸŸé—®é¢˜

#### ğŸ“‹ é—®é¢˜æè¿°

**ç°è±¡**:
```
Access to XMLHttpRequest at 'http://localhost:8000/api/v1/orders'
from origin 'http://localhost:5173' has been blocked by CORS policy
```

#### âœ… è§£å†³æ–¹æ¡ˆ

**åç«¯é…ç½®CORS**:
```python
# main.py
from fastapi.middleware.cors import CORSMiddleware

app.add_middleware(
    CORSMiddleware,
    allow_origins=["http://localhost:5173"],  # å¼€å‘ç¯å¢ƒ
    # allow_origins=["*"],  # âŒ ç”Ÿäº§ç¯å¢ƒä¸è¦ç”¨*
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```

**å‰ç«¯é…ç½®ä»£ç†ï¼ˆå¼€å‘ç¯å¢ƒï¼‰**:
```javascript
// vite.config.js
export default {
  server: {
    proxy: {
      '/api': {
        target: 'http://localhost:8000',
        changeOrigin: true
      }
    }
  }
}
```

#### ğŸ’¡ å­¦ä¹ è¦ç‚¹

**CORSåŸç†**:
1. æµè§ˆå™¨çš„åŒæºç­–ç•¥é™åˆ¶
2. åè®®ã€åŸŸåã€ç«¯å£ä¸‰è€…ç›¸åŒæ‰æ˜¯åŒæº
3. éœ€è¦æœåŠ¡ç«¯å…è®¸è·¨åŸŸè¯·æ±‚

---

## äº”ã€æ€§èƒ½ä¼˜åŒ–é—®é¢˜

### 5.1 æ•°æ®åº“N+1æŸ¥è¯¢é—®é¢˜

#### ğŸ“‹ é—®é¢˜æè¿°

**ç°è±¡**:
```python
# æŸ¥è¯¢è®¢å•åˆ—è¡¨
orders = await db.execute(select(Order)).scalars().all()

# éå†è®¢å•è·å–æ˜ç»†
for order in orders:
    items = await db.execute(
        select(OrderItem).where(OrderItem.order_id == order.id)
    ).scalars().all()
    # âŒ å¦‚æœæœ‰100ä¸ªè®¢å•ï¼Œä¼šæ‰§è¡Œ101æ¬¡æŸ¥è¯¢ï¼ˆ1+100ï¼‰
```

#### âœ… è§£å†³æ–¹æ¡ˆ

**ä½¿ç”¨å…³ç³»é¢„åŠ è½½**:
```python
# âœ… ä½¿ç”¨ selectinload é¢„åŠ è½½
stmt = select(Order).options(
    selectinload(Order.items),      # é¢„åŠ è½½è®¢å•æ˜ç»†
    selectinload(Order.customer)    # é¢„åŠ è½½å®¢æˆ·ä¿¡æ¯
)
orders = await db.execute(stmt).scalars().all()

# ç°åœ¨è®¿é—® order.items ä¸ä¼šè§¦å‘é¢å¤–æŸ¥è¯¢
for order in orders:
    print(order.items)  # âœ… å·²ç»åŠ è½½å¥½äº†
```

#### ğŸ’¡ å­¦ä¹ è¦ç‚¹

**åŠ è½½ç­–ç•¥**:
- `selectinload`: ä½¿ç”¨INæŸ¥è¯¢ï¼Œé€‚åˆä¸€å¯¹å¤š
- `joinedload`: ä½¿ç”¨JOINï¼Œé€‚åˆä¸€å¯¹ä¸€
- `subqueryload`: ä½¿ç”¨å­æŸ¥è¯¢

---

## å…­ã€æŒç»­æ›´æ–°

### æ·»åŠ æ–°é—®é¢˜çš„æ¨¡æ¿

```markdown
### X.X é—®é¢˜æ ‡é¢˜

#### ğŸ“‹ é—®é¢˜æè¿°
- ç°è±¡
- é”™è¯¯ä¿¡æ¯
- å¤ç°æ­¥éª¤

#### ğŸ” æ ¹æœ¬åŸå› 
- æŠ€æœ¯åŸå› 
- ä¸šåŠ¡é€»è¾‘
- è®¾è®¡ç¼ºé™·

#### âœ… è§£å†³æ–¹æ¡ˆ
- ä»£ç ç¤ºä¾‹
- é…ç½®ä¿®æ”¹
- æ¶æ„è°ƒæ•´

#### ğŸ’¡ å­¦ä¹ è¦ç‚¹
- æ ¸å¿ƒæ¦‚å¿µ
- æœ€ä½³å®è·µ
- é¢„é˜²æªæ–½
- ç›¸å…³æ–‡æ¡£
```

### å¾…è¡¥å……çš„é—®é¢˜

**é«˜ä¼˜å…ˆçº§**:
- [ ] WebSocketå®æ—¶é€šçŸ¥å®ç°
- [ ] æ–‡ä»¶ä¸Šä¼ ä¸å­˜å‚¨
- [x] æ•°æ®å¯¼å…¥å¯¼å‡ºï¼ˆExcelï¼‰ï¼ˆå·²å®Œæˆ 2025-12-26ï¼‰
- [x] æ‰“å°åŠŸèƒ½å®ç°ï¼ˆå·²å®Œæˆ 2025-12-26ï¼‰
- [ ] æ€§èƒ½ç›‘æ§ä¸æ—¥å¿—

**ä¸­ä¼˜å…ˆçº§**:
- [ ] å•å…ƒæµ‹è¯•ç¼–å†™
- [ ] Dockeréƒ¨ç½²
- [ ] ç¯å¢ƒå˜é‡ç®¡ç†
- [ ] é”™è¯¯å¤„ç†ä¸å¼‚å¸¸æ•è·
- [ ] APIæ–‡æ¡£è‡ªåŠ¨ç”Ÿæˆ

**ä½ä¼˜å…ˆçº§**:
- [ ] ä»£ç è§„èŒƒä¸Linté…ç½®
- [ ] Gitå·¥ä½œæµ
- [ ] CI/CDæµç¨‹
- [ ] å®‰å…¨åŠ å›º

---

## ä¸ƒã€å­¦ä¹ èµ„æº

### å®˜æ–¹æ–‡æ¡£
- [FastAPI](https://fastapi.tiangolo.com/)
- [SQLAlchemy 2.0](https://docs.sqlalchemy.org/en/20/)
- [Pydantic V2](https://docs.pydantic.dev/latest/)
- [Vue 3](https://cn.vuejs.org/)
- [Pinia](https://pinia.vuejs.org/zh/)
- [Axios](https://axios-http.com/)

### æ¨èé˜…è¯»
- ã€ŠEffective Pythonã€‹
- ã€ŠPythonå¼‚æ­¥ç¼–ç¨‹ã€‹
- ã€ŠVue.jsè®¾è®¡ä¸å®ç°ã€‹

### é¡¹ç›®æ–‡æ¡£
- [README.md](./README.md) - é¡¹ç›®è¯´æ˜
- [QUICKSTART.md](./QUICKSTART.md) - å¿«é€Ÿå¼€å§‹
- [SESSION_SUMMARY_*.md](./SESSION_SUMMARY_20251224.md) - å¼€å‘è®°å½•

---

**æœ€åæ›´æ–°**: 2025-12-26
**ç»´æŠ¤äººå‘˜**: å¼€å‘å›¢é˜Ÿ
**ç‰ˆæœ¬**: v1.2 (æ–°å¢: Excelæ–‡ä»¶ä¸‹è½½å“åº”æ‹¦æˆªå™¨å†²çªé—®é¢˜)

æ¬¢è¿è¡¥å……æ–°çš„é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆï¼ğŸ’¡
