# Print-ERP é¡¹ç›®çŠ¶æ€æ€»ç»“
> æœ€åæ›´æ–°ï¼š2024-12-26

## ä¸€ã€é¡¹ç›®æ¦‚è¿°

### æŠ€æœ¯æ ˆ
- **åç«¯**: FastAPI + SQLAlchemy (å¼‚æ­¥) + MySQL
- **å‰ç«¯**: Vue 3 + Element Plus + Vite
- **Python**: Poetry ç¯å¢ƒç®¡ç†
- **è®¤è¯**: JWT Token

### é¡¹ç›®ç»“æ„
```
C:\Project\ERP-p\
â”œâ”€â”€ backend/                 # FastAPIåç«¯
â”‚   â”œâ”€â”€ app/
â”‚   â”‚   â”œâ”€â”€ api/v1/endpoints/  # APIç«¯ç‚¹
â”‚   â”‚   â”œâ”€â”€ models/            # æ•°æ®åº“æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ schemas/           # Pydanticæ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ services/          # ä¸šåŠ¡é€»è¾‘
â”‚   â”‚   â””â”€â”€ utils/             # å·¥å…·ç±»
â”‚   â””â”€â”€ pyproject.toml
â”œâ”€â”€ frontend/               # Vue 3å‰ç«¯
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ api/             # APIå°è£…
â”‚   â”‚   â”œâ”€â”€ views/           # é¡µé¢ç»„ä»¶
â”‚   â”‚   â””â”€â”€ router/          # è·¯ç”±é…ç½®
â”‚   â””â”€â”€ package.json
â”œâ”€â”€ start.bat              # å¯åŠ¨è„šæœ¬
â””â”€â”€ stop.bat               # åœæ­¢è„šæœ¬
```

## äºŒã€æ ¸å¿ƒåŠŸèƒ½æ¨¡å—

### 1. å®¢æˆ·ç®¡ç† (Customers)
- âœ… CRUDå®Œæ•´
- âœ… Excelå¯¼å…¥/å¯¼å‡º
- âœ… å‰åç«¯å·²å®Œæˆå¹¶æµ‹è¯•é€šè¿‡

### 2. ç‰©æ–™ç®¡ç† (Materials)
- âœ… CRUDå®Œæ•´
- âœ… Excelå¯¼å…¥/å¯¼å‡º
- âœ… **æœ€æ–°ä¿®å¤**ï¼šå¯¼å‡ºæ•°æ®æ ¼å¼åŒ–ï¼ˆæšä¸¾è½¬ä¸­æ–‡ã€è§„æ ¼å­—æ®µï¼‰
- âš ï¸ éœ€é‡å¯åæµ‹è¯•

### 3. è®¢å•ç®¡ç† (Orders)
- âœ… CRUDå®Œæ•´
- âœ… Excelå¯¼å‡º
- âœ… å‰åç«¯å·²å®Œæˆ
- âš ï¸ æœªæµ‹è¯•

### 4. è´¢åŠ¡æŠ¥è¡¨ (Reports)
- âœ… å››ç§æŠ¥è¡¨APIï¼š
  - æ”¶æ¬¾æ—¥æŠ¥ (daily-payments)
  - å®¢æˆ·æ¬ æ¬¾ç»Ÿè®¡ (customer-receivables)
  - è´¦é¾„åˆ†æ (receivables-aging)
  - è´¢åŠ¡æ¦‚è§ˆ (financial-overview)
- âœ… Excelå¯¼å‡ºåŠŸèƒ½
- âœ… **æœ€æ–°ä¿®å¤**ï¼šè´¢åŠ¡æ¦‚è§ˆå¯¼å‡ºçš„Decimalæ ¼å¼åŒ–é—®é¢˜
- âš ï¸ éœ€é‡å¯åæµ‹è¯•

## ä¸‰ã€æœ€è¿‘å®Œæˆçš„å·¥ä½œ

### æœ¬æ¬¡ä¼šè¯å®Œæˆå†…å®¹

#### 1. å‰ç«¯ExcelåŠŸèƒ½å®ç°ï¼ˆå·²å®Œæˆï¼‰
**æ–‡ä»¶ï¼š** `frontend/src/api/*.js`
- âœ… `material.js`: æ·»åŠ æ¨¡æ¿ä¸‹è½½ã€å¯¼å…¥ã€å¯¼å‡º
- âœ… `order.js`: æ·»åŠ å¯¼å‡ºåŠŸèƒ½
- âœ… `report.js`: æ·»åŠ 4ç§æŠ¥è¡¨å¯¼å‡º

**æ–‡ä»¶ï¼š** `frontend/src/views/*.vue`
- âœ… `Customers.vue`: ExcelæŒ‰é’®å’Œå¤„ç†å‡½æ•°
- âœ… `Materials.vue`: ExcelæŒ‰é’®å’Œå¤„ç†å‡½æ•°
- âœ… `Orders.vue`: å¯¼å‡ºæŒ‰é’®
- âœ… `Reports.vue`: 4ä¸ªå¯¼å‡ºæŒ‰é’®ï¼ˆä¸åŒä½ç½®ï¼‰

#### 2. ä¿®å¤ï¼šExcelä¸‹è½½å“åº”æ‹¦æˆªå™¨å†²çªï¼ˆå·²å®Œæˆï¼‰
**æ–‡ä»¶ï¼š** `frontend/src/api/excel.js`

**é—®é¢˜ï¼š**
```javascript
// é”™è¯¯ï¼šCannot read properties of undefined (reading 'type')
if (response.data.type === 'application/json')
```

**æ ¹æœ¬åŸå› ï¼š**
- `request.js`çš„å“åº”æ‹¦æˆªå™¨è¿”å›`response.data`ï¼Œä¸¢å¤±äº†`response.headers`
- Excelä¸‹è½½éœ€è¦ä»`Content-Disposition`å¤´æå–æ–‡ä»¶å

**è§£å†³æ–¹æ¡ˆï¼š**
```javascript
// åˆ›å»ºç‹¬ç«‹çš„fileRequestå®ä¾‹ï¼Œä¸ä½¿ç”¨å“åº”æ‹¦æˆªå™¨
const fileRequest = axios.create({
  baseURL: 'http://localhost:8000/api/v1',
  timeout: 60000
})

// åªæ·»åŠ è¯·æ±‚æ‹¦æˆªå™¨ï¼ˆtokenï¼‰
fileRequest.interceptors.request.use(config => {
  const token = localStorage.getItem('access_token')
  if (token) {
    config.headers.Authorization = `Bearer ${token}`
  }
  return config
})
```

**å·²è®°å½•åˆ°ï¼š** `å¼€å‘é—®é¢˜é›†é”¦ä¸è§£å†³æ–¹æ¡ˆ.md` ç¬¬2.3èŠ‚

#### 3. ä¿®å¤ï¼šç‰©æ–™å¯¼å‡ºæ•°æ®é—®é¢˜ï¼ˆå·²å®Œæˆï¼Œå¾…æµ‹è¯•ï¼‰
**æ–‡ä»¶ï¼š** `backend/app/api/v1/endpoints/materials.py` (è¡Œ268-307)

**é—®é¢˜ï¼š**
- æšä¸¾å€¼æ˜¾ç¤ºä¸º `MaterialCategory.PAPER` è€Œé `çº¸å¼ `
- å­—æ®µä¸ºç©ºï¼šè§„æ ¼ã€å•ä½ã€å•ä»·ã€åº“å­˜æ•°é‡

**ä¿®å¤å†…å®¹ï¼š**
```python
# 1. æšä¸¾è½¬ä¸­æ–‡
category_map = {'PAPER': 'çº¸å¼ ', 'INK': 'æ²¹å¢¨', 'AUX': 'è¾…æ–™'}
material_dict['category'] = category_map.get(category_value, category_value)

# 2. æ ¼å¼åŒ–è§„æ ¼
if material.category == MaterialCategory.PAPER:
    material_dict['specification'] = f"{material.spec_width}Ã—{material.spec_length}mm {material.gram_weight}g"

# 3. å­—æ®µæ˜ å°„
material_dict['unit'] = material_dict.get('stock_unit', 'å¼ ')
material_dict['unit_price'] = material_dict.get('cost_price', 0)
material_dict['stock_quantity'] = material_dict.get('current_stock', 0)
```

#### 4. ä¿®å¤ï¼šè´¢åŠ¡æ¦‚è§ˆå¯¼å‡ºå¤±è´¥ï¼ˆå·²å®Œæˆï¼Œå¾…æµ‹è¯•ï¼‰
**æ–‡ä»¶ï¼š** `backend/app/api/v1/endpoints/reports.py` (è¡Œ344-410)

**é—®é¢˜ï¼š**
```
{"detail":"å¯¼å‡ºå¤±è´¥: 'order_stats'"}
```

**æ ¹æœ¬åŸå› ï¼š**
- `model_dump()` å°†Decimalè½¬ä¸ºå­—ç¬¦ä¸²
- ç›´æ¥ç”¨ `.2f` æ ¼å¼åŒ–å­—ç¬¦ä¸²ä¼šå¤±è´¥

**ä¿®å¤å†…å®¹ï¼š**
```python
from decimal import Decimal

def to_float(value):
    if isinstance(value, str):
        return float(value)
    elif isinstance(value, Decimal):
        return float(value)
    return value

# ä½¿ç”¨ç¤ºä¾‹
'æ•°å€¼': f"{to_float(overview_dict['total_order_amount']):.2f}"
```

## å››ã€å½“å‰å·²çŸ¥é—®é¢˜

### ğŸ”´ ç´§æ€¥é—®é¢˜
1. **å¤šä¸ªåç«¯è¿›ç¨‹å†²çª**
   - ç°è±¡ï¼š8000ç«¯å£æœ‰4ä¸ªè¿›ç¨‹ç›‘å¬
   - å½±å“ï¼šä»£ç ä¿®æ”¹ä¸ç”Ÿæ•ˆ
   - è§£å†³ï¼šé‡å¯ç”µè„‘æˆ–æ‰‹åŠ¨æ¸…ç†æ‰€æœ‰Pythonè¿›ç¨‹

### ğŸŸ¡ å¾…éªŒè¯
1. **ç‰©æ–™å¯¼å‡º**ï¼šä¿®å¤å·²å®Œæˆï¼Œéœ€é‡å¯åéªŒè¯
2. **è´¢åŠ¡æ¦‚è§ˆå¯¼å‡º**ï¼šä¿®å¤å·²å®Œæˆï¼Œéœ€é‡å¯åéªŒè¯
3. **è®¢å•å¯¼å‡º**ï¼šä»£ç å·²å®Œæˆï¼Œä»æœªæµ‹è¯•è¿‡

## äº”ã€é‡å¯åçš„æµ‹è¯•æ¸…å•

### æ­¥éª¤1ï¼šæ¸…ç†ç¼“å­˜
```bash
cd C:\Project\ERP-p\backend
del /s /q *.pyc
for /d /r . %%d in (__pycache__) do @if exist "%%d" rd /s /q "%%d"
```

### æ­¥éª¤2ï¼šå¯åŠ¨æœåŠ¡
```bash
cd C:\Project\ERP-p
start.bat
```

### æ­¥éª¤3ï¼šæµ‹è¯•é¡¹ç›®

#### æµ‹è¯•1ï¼šç‰©æ–™å¯¼å‡º
```bash
# ç™»å½•
curl -X POST http://localhost:8000/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d "{\"username\":\"admin\",\"password\":\"admin123\"}"

# å¯¼å‡ºç‰©æ–™ï¼ˆä½¿ç”¨è¿”å›çš„tokenï¼‰
curl -X GET "http://localhost:8000/api/v1/materials/excel/export" \
  -H "Authorization: Bearer <TOKEN>" \
  --output material_test.xlsx
```

**é¢„æœŸç»“æœï¼š**
- âœ… æ–‡ä»¶ç±»å‹ï¼š`Microsoft Excel 2007+`
- âœ… ç‰©æ–™åˆ†ç±»æ˜¾ç¤ºï¼š`çº¸å¼ ` è€Œé `MaterialCategory.PAPER`
- âœ… è§„æ ¼æ ¼å¼ï¼š`å®½Ã—é•¿mm å…‹é‡g`
- âœ… å•ä½ã€å•ä»·ã€åº“å­˜å­—æ®µæœ‰å€¼

#### æµ‹è¯•2ï¼šè´¢åŠ¡æ¦‚è§ˆå¯¼å‡º
```bash
curl -X GET "http://localhost:8000/api/v1/reports/excel/financial-overview" \
  -H "Authorization: Bearer <TOKEN>" \
  --output financial_test.xlsx
```

**é¢„æœŸç»“æœï¼š**
- âœ… æ–‡ä»¶ç±»å‹ï¼š`Microsoft Excel 2007+`
- âœ… åŒ…å«4ä¸ªSheetï¼šè®¢å•ç»Ÿè®¡ã€æ”¶æ¬¾ç»Ÿè®¡ã€åº”æ”¶æ¬¾ç»Ÿè®¡ã€æœ¬æœˆç»Ÿè®¡
- âœ… é‡‘é¢å­—æ®µæ ¼å¼åŒ–ä¸ºä¸¤ä½å°æ•°

#### æµ‹è¯•3ï¼šè®¢å•å¯¼å‡º
```bash
curl -X GET "http://localhost:8000/api/v1/orders/excel/export" \
  -H "Authorization: Bearer <TOKEN>" \
  --output order_test.xlsx
```

#### æµ‹è¯•4ï¼šå‰ç«¯æµ‹è¯•
1. è®¿é—® http://localhost:5173
2. ç™»å½•ï¼ˆadmin/admin123ï¼‰
3. æµ‹è¯•å„æ¨¡å—çš„ExcelåŠŸèƒ½ï¼š
   - å®¢æˆ·ç®¡ç†ï¼šä¸‹è½½æ¨¡æ¿ã€å¯¼å…¥ã€å¯¼å‡º
   - ç‰©æ–™ç®¡ç†ï¼šä¸‹è½½æ¨¡æ¿ã€å¯¼å…¥ã€å¯¼å‡º
   - è®¢å•ç®¡ç†ï¼šå¯¼å‡º
   - è´¢åŠ¡æŠ¥è¡¨ï¼š4ç§æŠ¥è¡¨å¯¼å‡º

## å…­ã€æ•°æ®åº“ä¿¡æ¯

### æ•°æ®åº“é…ç½®
- **ä½ç½®**: `backend/.env`
- **é»˜è®¤åº“**: `print_erp`
- **é»˜è®¤ç”¨æˆ·**: admin / admin123

### ä¸»è¦æ•°æ®è¡¨
- `erp_users`: ç”¨æˆ·è¡¨
- `erp_customers`: å®¢æˆ·è¡¨
- `erp_materials`: ç‰©æ–™è¡¨
- `erp_orders`: è®¢å•è¡¨
- `erp_order_items`: è®¢å•æ˜ç»†è¡¨
- `erp_payments`: æ”¶æ¬¾è®°å½•è¡¨

## ä¸ƒã€æ ¸å¿ƒæ–‡ä»¶æ¸…å•

### åç«¯å…³é”®æ–‡ä»¶
| æ–‡ä»¶ | è¯´æ˜ | æœ€è¿‘ä¿®æ”¹ |
|------|------|----------|
| `backend/app/api/v1/endpoints/materials.py` | ç‰©æ–™API | âœ… æšä¸¾è½¬æ¢ä¿®å¤ |
| `backend/app/api/v1/endpoints/reports.py` | æŠ¥è¡¨API | âœ… Decimalæ ¼å¼åŒ–ä¿®å¤ |
| `backend/app/utils/excel_handler.py` | Excelå·¥å…·ç±» | æ— ä¿®æ”¹ |
| `backend/app/services/report_service.py` | æŠ¥è¡¨æœåŠ¡ | æ— ä¿®æ”¹ |

### å‰ç«¯å…³é”®æ–‡ä»¶
| æ–‡ä»¶ | è¯´æ˜ | æœ€è¿‘ä¿®æ”¹ |
|------|------|----------|
| `frontend/src/api/excel.js` | Excelé€šç”¨å‡½æ•° | âœ… å“åº”æ‹¦æˆªå™¨ä¿®å¤ |
| `frontend/src/api/material.js` | ç‰©æ–™API | âœ… æ·»åŠ Excelå‡½æ•° |
| `frontend/src/api/order.js` | è®¢å•API | âœ… æ·»åŠ å¯¼å‡ºå‡½æ•° |
| `frontend/src/api/report.js` | æŠ¥è¡¨API | âœ… æ·»åŠ 4ç§å¯¼å‡º |
| `frontend/src/views/Materials.vue` | ç‰©æ–™é¡µé¢ | âœ… æ·»åŠ ExcelæŒ‰é’® |
| `frontend/src/views/Orders.vue` | è®¢å•é¡µé¢ | âœ… æ·»åŠ å¯¼å‡ºæŒ‰é’® |
| `frontend/src/views/Reports.vue` | æŠ¥è¡¨é¡µé¢ | âœ… æ·»åŠ 4ä¸ªå¯¼å‡ºæŒ‰é’® |

## å…«ã€å¯åŠ¨å‘½ä»¤å¿«é€Ÿå‚è€ƒ

### å¯åŠ¨æ•´ä¸ªé¡¹ç›®
```bash
cd C:\Project\ERP-p
start.bat
```

### å•ç‹¬å¯åŠ¨åç«¯
```bash
cd C:\Project\ERP-p\backend
poetry run uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

### å•ç‹¬å¯åŠ¨å‰ç«¯
```bash
cd C:\Project\ERP-p\frontend
npm run dev
```

### åœæ­¢æ‰€æœ‰æœåŠ¡
```bash
cd C:\Project\ERP-p
stop.bat
```

æˆ–æ‰‹åŠ¨ï¼š
```bash
taskkill /F /IM python.exe
taskkill /F /IM node.exe
```

## ä¹ã€ä¸‹ä¸€æ­¥å·¥ä½œå»ºè®®

### ç«‹å³æ‰§è¡Œ
1. âœ… é‡å¯ç”µè„‘
2. âœ… æ¸…ç†Pythonç¼“å­˜
3. âœ… å¯åŠ¨æœåŠ¡
4. âœ… æ‰§è¡Œæµ‹è¯•æ¸…å•

### åç»­ä¼˜åŒ–
1. æ·»åŠ å‰ç«¯è¡¨å•éªŒè¯
2. ä¼˜åŒ–Excelå¯¼å…¥çš„é”™è¯¯æç¤º
3. æ·»åŠ å¯¼å‡ºè¿›åº¦æç¤º
4. è€ƒè™‘å¤§æ•°æ®é‡å¯¼å‡ºçš„æ€§èƒ½ä¼˜åŒ–

## åã€å¸¸è§é—®é¢˜

### Q1: åç«¯ä¿®æ”¹ä¸ç”Ÿæ•ˆï¼Ÿ
**A:** æ¸…ç†ç¼“å­˜å¹¶é‡å¯ï¼š
```bash
cd backend
del /s /q *.pyc
for /d /r . %%d in (__pycache__) do @if exist "%%d" rd /s /q "%%d"
```

### Q2: Excelä¸‹è½½å¤±è´¥ï¼Ÿ
**A:** æ£€æŸ¥ï¼š
1. æ˜¯å¦ä½¿ç”¨äº†æ­£ç¡®çš„token
2. tokenæ˜¯å¦è¿‡æœŸï¼ˆæœ‰æ•ˆæœŸ24å°æ—¶ï¼‰
3. åç«¯æ—¥å¿—ä¸­çš„é”™è¯¯ä¿¡æ¯

### Q3: ç«¯å£è¢«å ç”¨ï¼Ÿ
**A:** æŸ¥çœ‹å¹¶æ¸…ç†ï¼š
```bash
# æŸ¥çœ‹8000ç«¯å£
netstat -ano | findstr :8000

# æ€æ­»è¿›ç¨‹
taskkill /F /PID <è¿›ç¨‹ID>
```

---

**æ–‡æ¡£ç»´æŠ¤**: æ¯æ¬¡é‡å¤§ä¿®æ”¹åæ›´æ–°æ­¤æ–‡ä»¶
**ç‰ˆæœ¬**: v1.0
**ä½œè€…**: Claude Code
